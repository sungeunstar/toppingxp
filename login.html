<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ToppingXP — Login</title>

<!-- Supabase SDK + 외부 키 파일 -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="js/supabase.js"></script>

<style>
:root{
  --bg:#070c10; --g:#7aff7a; --g-deep:#1c7a1c;
  --glow:0 0 10px rgba(121,255,121,.5),0 0 18px rgba(121,255,121,.25);
  --btn-bg:#0a140a; --btn-bg-hover:#0f1d0f;
  --text-soft:#b6ffb6; --text-hover:#d4f77c;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; overflow:hidden;
  color:var(--g); font-family:ui-monospace, Menlo, Consolas, monospace;
  background:#050a0d;
}

/* 로그인 카드 중앙 */
.center{
  position:fixed; inset:0; display:flex; justify-content:center; align-items:center; z-index:10;
}
.card{
  width:min(420px,90%); padding:26px 22px;
  background: rgba(8,18,8,.65);
  border:1px solid rgba(28,122,28,.55);
  box-shadow:0 0 24px rgba(0,0,0,.55), inset 0 0 0 2px rgba(28,122,28,.15);
  backdrop-filter: blur(6px); border-radius:10px;
}
.h1{font-size:22px; font-weight:900; margin:0 0 6px; text-shadow:var(--glow)}
.sub{color:#a7ffa7; margin:0 0 14px; font-size:14px}
.row{display:grid; gap:10px; margin:12px 0}
.input{
  width:100%; padding:12px; border:2px solid var(--g-deep); background:rgba(10,19,10,.85); color:var(--g);
  font-size:15px; border-radius:8px;
}
.btn{
  padding:12px 14px; border:2px solid var(--g); background:rgba(10,20,10,.9); color:var(--text-soft);
  font-weight:800; cursor:pointer; box-shadow:var(--glow); border-radius:8px;
}
.btn:hover{background:var(--btn-bg-hover); color:var(--text-hover)}
.help{display:flex; justify-content:space-between; align-items:center; margin-top:8px; font-size:13px; color:var(--text-soft)}
.link{color:var(--text-hover); text-decoration:underline; cursor:pointer}
.msg{margin-top:10px; font-size:13px}
.msg.ok{color:#9bffa4} .msg.err{color:#ff7272}

/* 회원가입 모달 */
.modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.45)}
.modal.show{display:flex}
.modalCard{
  width:min(540px,92%); background: rgba(9,17,9,.7);
  border:2px solid rgba(28,122,28,.6); box-shadow:var(--glow);
  padding:16px; display:grid; gap:12px; backdrop-filter: blur(6px); border-radius:10px;
}
.modalBtns{display:flex; gap:8px; justify-content:flex-end}

/* 게임 배경 */
#gameWrap{position:fixed; inset:0; z-index:0;}
#game{display:block; width:100vw; height:100vh}
</style>
</head>
<body>
<div class="app">
  <div id="gameWrap"><canvas id="game"></canvas></div>

  <div class="center">
    <div class="card">
      <div class="h1">ToppingXP</div>
      <p class="sub">로그인 후 퀘스트와 회고 데이터를 저장/동기화합니다.</p>

      <div class="row">
        <input id="email" class="input" placeholder="이메일" autocomplete="email" />
        <input id="password" class="input" type="password" placeholder="비밀번호" autocomplete="current-password" />
        <button id="signin" class="btn">로그인</button>
        <div class="help">
          <span>계정이 없나요?</span>
          <span id="openSignup" class="link">회원가입</span>
        </div>
        <div id="loginMsg" class="msg"></div>
      </div>
    </div>
  </div>
</div>

<!-- 회원가입 모달 -->
<div id="signupModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="signupTitle">
  <div class="modalCard">
    <div class="h1" id="signupTitle" style="font-size:18px">회원가입</div>
    <div class="row">
      <input id="su_name" class="input" placeholder="표시 이름" />
      <input id="su_email" class="input" placeholder="이메일" />
      <input id="su_pw" class="input" type="password" placeholder="비밀번호" />
      <input id="su_pw2" class="input" type="password" placeholder="비밀번호 확인" />
    </div>
    <div class="modalBtns">
      <button id="signupBtn" class="btn">가입하기</button>
      <button id="closeSignup" class="btn">닫기</button>
    </div>
    <div id="signupMsg" class="msg"></div>
  </div>
</div>

<script>
/* ========== 로그인 로직 ========== */
const $=id=>document.getElementById(id);
const els={
  email:$('email'), password:$('password'), signin:$('signin'),
  loginMsg:$('loginMsg'), openSignup:$('openSignup'), signupBtn:$('signupBtn'),
  su_name:$('su_name'), su_email:$('su_email'), su_pw:$('su_pw'), su_pw2:$('su_pw2'),
  signupMsg:$('signupMsg'), closeSignup:$('closeSignup'), modal:$('signupModal')
};
function showMsg(el, text, ok=false){ el.textContent=text; el.className='msg '+(ok?'ok':'err'); }
(async function guard(){const {data:{user}}=await sb.auth.getUser(); if(user)location.href="index.html";})();

els.signin.onclick=async()=>{
  els.loginMsg.textContent='';
  const email=els.email.value.trim(), pw=els.password.value;
  if(!email||!pw){showMsg(els.loginMsg,'이메일과 비밀번호를 입력하세요');return;}
  const {error}=await sb.auth.signInWithPassword({email,password:pw});
  if(error)showMsg(els.loginMsg,error.message);else location.href="index.html";
};
els.openSignup.onclick=()=>els.modal.classList.add('show');
els.closeSignup.onclick=()=>els.modal.classList.remove('show');
els.signupBtn.onclick=async()=>{
  const name=els.su_name.value.trim(), email=els.su_email.value.trim();
  const pw=els.su_pw.value, pw2=els.su_pw2.value;
  if(!email||!pw){showMsg(els.signupMsg,'모두 입력해주세요');return;}
  if(pw!==pw2){showMsg(els.signupMsg,'비밀번호 불일치');return;}
  const {data,error}=await sb.auth.signUp({email,password:pw,options:{data:{display_name:name||null}}});
  if(error)return showMsg(els.signupMsg,error.message);
  if(data.user)await sb.from('profiles').upsert({id:data.user.id,display_name:name||email.split('@')[0]});
  showMsg(els.signupMsg,'가입 완료! 로그인해주세요.',true);
  setTimeout(()=>els.modal.classList.remove('show'),1000);
};

/* ========== 배경 게임: 동굴 배경 + 바닥 움직임 + 발사 ========== */

/* 업로드한 배경 URL로 교체 */
const BACKGROUND_URL = "https://mgpxqmqvlbjfywbbsiwt.supabase.co/storage/v1/object/public/images/background.png"; /* ← 교체 */

const SPRITES = {
  stopRight: "https://mgpxqmqvlbjfywbbsiwt.supabase.co/storage/v1/object/public/images/stop-right.png",
  right:     "https://mgpxqmqvlbjfywbbsiwt.supabase.co/storage/v1/object/public/images/right.png",
  center:    "https://mgpxqmqvlbjfywbbsiwt.supabase.co/storage/v1/object/public/images/center.png",
  attack:    "https://mgpxqmqvlbjfywbbsiwt.supabase.co/storage/v1/object/public/images/attack.png",
  back:      "https://mgpxqmqvlbjfywbbsiwt.supabase.co/storage/v1/object/public/images/back.png",
  fireSmall: "https://mgpxqmqvlbjfywbbsiwt.supabase.co/storage/v1/object/public/images/small-fire.png",
  fireBig:   "https://mgpxqmqvlbjfywbbsiwt.supabase.co/storage/v1/object/public/images/fire.png"
};
const IDLE_FRAMES=[SPRITES.stopRight];
const WALK_FRAMES=[SPRITES.right, SPRITES.stopRight];

const EVERY_N_BIG = 3;

const canvas=$('game'), ctx=canvas.getContext('2d',{alpha:false});
let W=innerWidth,H=innerHeight; canvas.width=W; canvas.height=H;
addEventListener('resize',()=>{W=innerWidth;H=innerHeight;canvas.width=W;canvas.height=H; recomputeFloor();});
ctx.imageSmoothingEnabled=false;

function load(url){ const i=new Image(); i.decoding='async'; i.src=url; return i; }
const BG = load(BACKGROUND_URL);
const IMGS={
  idle:IDLE_FRAMES.map(load), walk:WALK_FRAMES.map(load),
  center:load(SPRITES.center), back:load(SPRITES.back), attack:load(SPRITES.attack),
  fireSmall:load(SPRITES.fireSmall), fireBig:load(SPRITES.fireBig)
};

/* 월드/카메라 */
let floorY = 0;         // 바닥 y 좌표
let bgScale = 1;        // 배경 스케일
let bgH = 0, bgW = 0;   // 배경 실제 렌더 크기
let camX = 0;           // 카메라 x (배경 스크롤)
const WORLD_SPEED = 0.6; // 카메라 패닝 민감도

function recomputeFloor(){
  if(!BG.naturalWidth){ floorY = H - 120; return; }
  // 화면 높이에 배경을 꽉 채우되 비율 유지
  bgScale = H / BG.naturalHeight;
  bgW = Math.floor(BG.naturalWidth * bgScale);
  bgH = Math.floor(BG.naturalHeight * bgScale);
  // 배경 하단의 ‘돌 바닥’ 영역을 고려해 살짝 위로: 전체 높이의 약 0.14를 바닥 스트립으로 가정
  const groundStrip = Math.floor(bgH * 0.14);
  floorY = H - groundStrip - 4; // -4로 캐릭터 발이 딱 닿게
}
BG.onload = recomputeFloor;
recomputeFloor();

/* 플레이어 */
const player={
  x: W*0.5, y: 0, w:96, h:96,
  vx:0, speed: 160,
  dir:1, pose:'side',
  animTime:0, animIndex:0,
  attacking:0
};
function placeOnFloor(){ player.y = floorY - player.h; }
placeOnFloor();

const keys={left:false,right:false, space:false, up:false, down:false};
addEventListener('keydown',e=>{
  if(e.key===' '){
    const t = document.activeElement.tagName;
    if(t!=='INPUT' && t!=='TEXTAREA'){ e.preventDefault(); keys.space=true; }
  }
  if(['ArrowLeft','a','A'].includes(e.key)) keys.left=true;
  if(['ArrowRight','d','D'].includes(e.key)) keys.right=true;
  if(e.key==='ArrowUp') keys.up=true;
  if(e.key==='ArrowDown') keys.down=true;
});
addEventListener('keyup',e=>{
  if(e.key===' ') keys.space=false;
  if(['ArrowLeft','a','A'].includes(e.key)) keys.left=false;
  if(['ArrowRight','d','D'].includes(e.key)) keys.right=false;
  if(e.key==='ArrowUp') keys.up=false;
  if(e.key==='ArrowDown') keys.down=false;
});

/* 발사체 */
const shots=[]; let shotCount=0,lastShot=0;
function shoot(){
  const now=performance.now();
  if(now-lastShot<180) return;
  lastShot=now; shotCount++;

  const big = EVERY_N_BIG>0 && (shotCount % EVERY_N_BIG===0);
  const img = (big && IMGS.fireBig.complete)? IMGS.fireBig : IMGS.fireSmall;
  const size = big ? 54 : 32;
  const speed = big ? 520 : 420;

  const startX = player.dir===1 ? (player.x + player.w - 18) : (player.x + 18 - size);
  shots.push({
    x:startX, y: player.y + player.h*0.55 - size*0.5,
    vx: player.dir===1 ? speed : -speed,
    w:size, h:size, img, life:2200
  });

  player.attacking = 140;
}

/* 업데이트 */
let last=0;
function update(dt){
  // 입력 → 이동
  if(keys.left){ player.vx = -player.speed; player.dir=-1; }
  else if(keys.right){ player.vx =  player.speed; player.dir= 1; }
  else { player.vx *= 0.84; if(Math.abs(player.vx)<0.5) player.vx=0; }

  // 위/아래 포즈
  if(keys.up) player.pose='back';
  else if(keys.down) player.pose='front';
  else player.pose='side';

  if(keys.space) shoot();

  // 위치/카메라
  player.x += player.vx*dt;
  // 화면 중앙 근처에서 움직이면 카메라 패닝(배경 반복)
  camX += player.vx * dt * WORLD_SPEED;

  // 화면 밖으로 안나가게
  const minX = 10, maxX = W - player.w - 10;
  if(player.x<minX) player.x=minX;
  if(player.x>maxX) player.x=maxX;

  if(player.attacking>0) player.attacking -= dt*1000;

  // 애니메이션
  if(player.pose==='side' && Math.abs(player.vx)>1){
    player.animTime += dt*1000;
    if(player.animTime>120){ player.animTime=0; player.animIndex=(player.animIndex+1)%IMGS.walk.length; }
  }else{ player.animTime=0; player.animIndex=0; }

  // 발사체
  for(let i=shots.length-1;i>=0;i--){
    const s=shots[i]; s.x += s.vx*dt; s.life -= dt*1000;
    if(s.x<-s.w || s.x>W+s.w || s.life<=0) shots.splice(i,1);
  }

  // 바닥에 붙여두기
  placeOnFloor();
}

/* 그리기 */
function draw(){
  // 배경 타일링(가로 반복)
  if(BG.complete){
    const offset = Math.floor((camX*bgScale) % bgW);
    // 타일 3장 그려 끊김 방지
    const x0 = -offset - bgW;
    ctx.drawImage(BG, x0,          0, bgW, bgH);
    ctx.drawImage(BG, x0 + bgW,    0, bgW, bgH);
    ctx.drawImage(BG, x0 + bgW*2,  0, bgW, bgH);
  }else{
    ctx.fillStyle="#0b0f14"; ctx.fillRect(0,0,W,H);
  }

  // 발사체
  for(const s of shots){
    const dx=Math.round(s.x), dy=Math.round(s.y);
    if(s.img && s.img.complete){
      if(s.vx>=0) ctx.drawImage(s.img, dx, dy, s.w, s.h);
      else { ctx.save(); ctx.translate(dx+s.w,0); ctx.scale(-1,1); ctx.drawImage(s.img,0,dy,s.w,s.h); ctx.restore(); }
    }else{
      ctx.fillStyle="#ff9a00"; ctx.fillRect(dx,dy,s.w,s.h);
    }
  }

  // 플레이어 스프라이트 선택
  let img=null;
  if(player.pose==='front'){ img=IMGS.center; }
  else if(player.pose==='back'){ img=IMGS.back; }
  else{
    if(player.attacking>0 && IMGS.attack.complete) img=IMGS.attack;
    else if(Math.abs(player.vx)>1) img=IMGS.walk[player.animIndex]||IMGS.walk[0];
    else img=IMGS.idle[0];
  }

  const px=Math.round(player.x), py=Math.round(player.y);
  if(player.dir===1){
    if(img && img.complete) ctx.drawImage(img, px, py, player.w, player.h);
    else { ctx.fillStyle="#8f8"; ctx.fillRect(px,py,player.w,player.h); }
  }else{
    ctx.save(); ctx.translate(px+player.w,0); ctx.scale(-1,1);
    if(img && img.complete) ctx.drawImage(img, 0, py, player.w, player.h);
    else { ctx.fillStyle="#8f8"; ctx.fillRect(0,py,player.w,player.h); }
    ctx.restore();
  }
}

/* 루프 */
function loop(ts){
  const dt=Math.min(0.033,(ts-last)/1000||0.016); last=ts;
  update(dt); draw();
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
</script>
</body>
</html>
