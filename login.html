<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ToppingXP â€” Login</title>

<!-- Supabase SDK + ì™¸ë¶€ í‚¤ íŒŒì¼ -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="js/supabase.js"></script>

<style>
:root{
  --bg:#070c10; --g:#7aff7a; --g-deep:#1c7a1c;
  --glow:0 0 10px rgba(121,255,121,.5),0 0 18px rgba(121,255,121,.25);
  --btn-bg:#0a140a; --btn-bg-hover:#0f1d0f;
  --text-soft:#b6ffb6; --text-hover:#d4f77c;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; overflow:hidden;
  color:var(--g); font-family:ui-monospace, Menlo, Consolas, monospace;
  background: radial-gradient(1000px 700px at 50% 50%, #0b160b 0%, var(--bg) 70%);
}

/* ë¡œê·¸ì¸ ì¹´ë“œ ì¤‘ì•™ */
.center{
  position:fixed; inset:0; display:flex; justify-content:center; align-items:center; z-index:10;
  transition:opacity .18s ease, transform .18s ease;
}
.center.hide{opacity:0; pointer-events:none; transform:scale(.98)}
.card{
  width:min(420px,90%); padding:26px 22px;
  background: rgba(8,18,8,.65);
  border:1px solid rgba(28,122,28,.55);
  box-shadow:0 0 24px rgba(0,0,0,.55), inset 0 0 0 2px rgba(28,122,28,.15);
  backdrop-filter: blur(6px); border-radius:10px;
}
.h1{font-size:22px; font-weight:900; margin:0 0 6px; text-shadow:var(--glow)}
.sub{color:#a7ffa7; margin:0 0 14px; font-size:14px}
.row{display:grid; gap:10px; margin:12px 0}
.input{
  width:100%; padding:12px; border:2px solid var(--g-deep); background:rgba(10,19,10,.85); color:var(--g);
  font-size:15px; border-radius:8px;
}
.btn{
  padding:12px 14px; border:2px solid var(--g); background:rgba(10,20,10,.9); color:var(--text-soft);
  font-weight:800; cursor:pointer; box-shadow:var(--glow); border-radius:8px;
}
.btn:hover{background:var(--btn-bg-hover); color:var(--text-hover)}
.help{display:flex; justify-content:space-between; align-items:center; margin-top:8px; font-size:13px; color:var(--text-soft)}
.link{color:var(--text-hover); text-decoration:underline; cursor:pointer}
.msg{margin-top:10px; font-size:13px}
.msg.ok{color:#9bffa4} .msg.err{color:#ff7272}

/* íšŒì›ê°€ì… ëª¨ë‹¬ */
.modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.45); z-index:20}
.modal.show{display:flex}
.modalCard{
  width:min(540px,92%); background: rgba(9,17,9,.7);
  border:2px solid rgba(28,122,28,.6); box-shadow:var(--glow);
  padding:16px; display:grid; gap:12px; backdrop-filter: blur(6px); border-radius:10px;
  animation:pop .18s ease;
}
@keyframes pop{from{transform:scale(.98);opacity:0}to{transform:scale(1);opacity:1}}
.modalBtns{display:flex; gap:8px; justify-content:flex-end}

/* ê²Œì„ ë°°ê²½ */
#gameWrap{position:fixed; inset:0; z-index:0;}
#game{display:block; width:100vw; height:100vh}

/* í‚¤ ë„ì›€ë§(ì¢Œí•˜ë‹¨) */
.hint{
  position:fixed; left:14px; bottom:12px; z-index:9; font-size:12px; color:#a7ffa7; opacity:.85;
  background:rgba(0,0,0,.25); padding:6px 8px; border:1px solid rgba(28,122,28,.35); border-radius:6px
}
</style>
</head>
<body>
<div id="gameWrap"><canvas id="game"></canvas></div>

<div class="center" id="loginPanel">
  <div class="card">
    <div class="h1">ToppingXP</div>
    <p class="sub">ì˜¤ëŠ˜ë„ ë‹¹ì‹ ì˜ í•˜ë£¨ë¥¼ ë ˆë²¨ì—…ì„ í•˜ì„¸ìš”.:D</p>

    <div class="row">
      <input id="email" class="input" placeholder="ì´ë©”ì¼" autocomplete="email" />
      <input id="password" class="input" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" autocomplete="current-password" />
      <button id="signin" class="btn">ë¡œê·¸ì¸</button>
      <div class="help">
        <span>ê³„ì •ì´ ì—†ë‚˜ìš”?</span>
        <span id="openSignup" class="link" aria-haspopup="dialog">íšŒì›ê°€ì…</span>
      </div>
      <div id="loginMsg" class="msg"></div>
    </div>
  </div>
</div>

<div class="hint">â†/â†’ ì´ë™ Â· â†‘ ë“± ë³´ì´ê¸° Â· â†“ ì •ë©´ ë³´ê¸° Â· Space ë°œì‚¬</div>

<!-- íšŒì›ê°€ì… ëª¨ë‹¬ -->
<div id="signupModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="signupTitle">
  <div class="modalCard">
    <div class="h1" id="signupTitle" style="font-size:18px">íšŒì›ê°€ì…</div>
    <div class="row">
      <input id="su_name" class="input" placeholder="ë‹‰ë„¤ì„" />
      <input id="su_email" class="input" placeholder="ì´ë©”ì¼" />
      <input id="su_pw" class="input" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" />
      <input id="su_pw2" class="input" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸" />
    </div>
    <div class="modalBtns">
      <button id="signupBtn" class="btn">ê°€ì…í•˜ê¸°</button>
      <button id="closeSignup" class="btn">ë‹«ê¸°</button>
    </div>
    <div id="signupMsg" class="msg"></div>
  </div>
</div>

<!-- ë°°ê²½ ìŒì•… -->
<audio id="bgm" src="https://mgpxqmqvlbjfywbbsiwt.supabase.co/storage/v1/object/public/music/toppingxp.mp3" loop></audio>
<button id="musicBtn" style="
  position:fixed; top:16px; right:16px; z-index:30;
  background:rgba(10,20,10,.8); border:2px solid #7aff7a;
  color:#7aff7a; font-family:ui-monospace,Menlo,Consolas,monospace;
  font-weight:700; font-size:13px; padding:8px 12px; border-radius:8px;
  box-shadow:0 0 10px rgba(121,255,121,.3); cursor:pointer;">
ğŸµ Play
</button>

<script>
const music = document.getElementById('bgm');
const btn = document.getElementById('musicBtn');
let playing = false;

btn.onclick = ()=>{
  if(!playing){
    music.play();
    btn.textContent = "â¸ Pause";
    playing = true;
  }else{
    music.pause();
    btn.textContent = "ğŸµ Play";
    playing = false;
  }
};
</script>

<script>
/* ========== ì¸ì¦ ========== */
const $=id=>document.getElementById(id);
const els={
  email:$('email'), password:$('password'), signin:$('signin'),
  loginMsg:$('loginMsg'), openSignup:$('openSignup'), signupBtn:$('signupBtn'),
  su_name:$('su_name'), su_email:$('su_email'), su_pw:$('su_pw'), su_pw2:$('su_pw2'),
  signupMsg:$('signupMsg'), closeSignup:$('closeSignup'), modal:$('signupModal'),
  loginPanel:$('loginPanel')
};
function showMsg(el, text, ok=false){ el.textContent=text; el.className='msg '+(ok?'ok':'err'); }

(async function guard(){
  const {data:{user}}=await sb.auth.getUser();
  if(user) location.href="index.html";
})();

async function doSignin(){
  els.loginMsg.textContent='';
  const email=els.email.value.trim(), pw=els.password.value;
  if(!email||!pw){showMsg(els.loginMsg,'ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”');return;}
  const {error}=await sb.auth.signInWithPassword({email,password:pw});
  if(error)showMsg(els.loginMsg,error.message);else location.href="index.html";
}
els.signin.onclick=doSignin;
['email','password'].forEach(id=>{
  $(id).addEventListener('keydown',e=>{
    if(e.key==='Enter') doSignin();
  });
});

function openSignup(){
  els.modal.classList.add('show');
  els.loginPanel.classList.add('hide');
  // í¬ì»¤ìŠ¤ ì´ë™
  setTimeout(()=>els.su_name.focus(),0);
}
function closeSignup(){
  els.modal.classList.remove('show');
  els.loginPanel.classList.remove('hide');
  els.openSignup.focus();
}
els.openSignup.onclick=openSignup;
els.closeSignup.onclick=closeSignup;

// ESCë¡œ ë‹«ê¸°
document.addEventListener('keydown',e=>{
  if(e.key==='Escape' && els.modal.classList.contains('show')) closeSignup();
});

els.signupBtn.onclick=async()=>{
  const name=els.su_name.value.trim(), email=els.su_email.value.trim();
  const pw=els.su_pw.value, pw2=els.su_pw2.value;
  if(!name||!email||!pw||!pw2){showMsg(els.signupMsg,'ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”');return;}
  if(pw!==pw2){showMsg(els.signupMsg,'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤');return;}
  const {data,error}=await sb.auth.signUp({email,password:pw,options:{data:{display_name:name}}});
  if(error)return showMsg(els.signupMsg,error.message);
  if(data.user)await sb.from('profiles').upsert({id:data.user.id,display_name:name});
  showMsg(els.signupMsg,'ê°€ì… ì™„ë£Œ! ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.',true);
  setTimeout(()=>{ closeSignup(); }, 900);
};

/* ========== ë°°ê²½/ìºë¦­í„° ë¯¸ë‹ˆê²Œì„ ========== */

/* ë°°ê²½(ê°€ë¡œ ë°˜ë³µ íƒ€ì¼) */
const BG_URL = "https://mgpxqmqvlbjfywbbsiwt.supabase.co/storage/v1/object/public/images/background.png";

/* ìŠ¤í”„ë¼ì´íŠ¸ */
const SPRITES = {
  stopRight: "https://mgpxqmqvlbjfywbbsiwt.supabase.co/storage/v1/object/public/images/stop-right.png",
  right:     "https://mgpxqmqvlbjfywbbsiwt.supabase.co/storage/v1/object/public/images/right.png",
  center:    "https://mgpxqmqvlbjfywbbsiwt.supabase.co/storage/v1/object/public/images/center.png",
  back:      "https://mgpxqmqvlbjfywbbsiwt.supabase.co/storage/v1/object/public/images/back.png",
  attack:    "https://mgpxqmqvlbjfywbbsiwt.supabase.co/storage/v1/object/public/images/attack.png",
  fireSmall: "https://mgpxqmqvlbjfywbbsiwt.supabase.co/storage/v1/object/public/images/small-fire.png",
  fireBig:   "https://mgpxqmqvlbjfywbbsiwt.supabase.co/storage/v1/object/public/images/fire.png"
};
const EVERY_N_BIG = 3; // 3ë²ˆì§¸ë§ˆë‹¤ í° ë¶ˆê½ƒ

/* ìº”ë²„ìŠ¤ */
const canvas=$('game'), ctx=canvas.getContext('2d',{alpha:false});
let W=innerWidth,H=innerHeight; canvas.width=W; canvas.height=H;
addEventListener('resize',()=>{W=innerWidth;H=innerHeight;canvas.width=W;canvas.height=H; rebuildTile();});
ctx.imageSmoothingEnabled=false;

/* ì´ë¯¸ì§€ ë¡œë” */
const BG = new Image(); BG.decoding="async"; BG.src=BG_URL;
function loadImage(url){const img=new Image(); img.decoding="async"; img.src=url; return img;}
const IMGS={
  stopRight: loadImage(SPRITES.stopRight),
  right:     loadImage(SPRITES.right),
  center:    loadImage(SPRITES.center),
  back:      loadImage(SPRITES.back),
  attack:    loadImage(SPRITES.attack),
  fireSmall: loadImage(SPRITES.fireSmall),
  fireBig:   loadImage(SPRITES.fireBig)
};

/* ë°°ê²½: ì˜¤í”„ìŠ¤í¬ë¦° íƒ€ì¼ íŒ¨í„´(ì´ìŒì„  ì œê±°) */
let bgScale=1, floorY=H-60, camX=0;
let tileCan=null, tileCtx=null, tileW=0, tileH=0, bgPattern=null;

function placeOnFloor(){ player.y = floorY - player.h; }

/* ì¤„ ì œê±°ìš© */
function rebuildTile(){
  if(!BG.complete) return;

  bgScale = H / BG.naturalHeight;

  tileW = Math.ceil(BG.naturalWidth * bgScale);
  tileH = Math.ceil(BG.naturalHeight * bgScale);

  tileCan = document.createElement('canvas');
  tileCan.width  = tileW + 2;
  tileCan.height = tileH;
  tileCtx = tileCan.getContext('2d',{alpha:false});
  tileCtx.imageSmoothingEnabled=false;

  tileCtx.drawImage(BG, 0, 0, tileW + 1, tileH);

  bgPattern = ctx.createPattern(tileCan,'repeat-x');

  const groundStrip = Math.round(tileH * 0.14);
  floorY = H - groundStrip - 4;
  placeOnFloor();
}
BG.onload = () => rebuildTile();

function drawBGPattern(g){
  if(!bgPattern) return;
  g.save();
  g.setTransform(1,0,0,1,0,0);
  g.imageSmoothingEnabled=false;

  const raw = camX * bgScale;
  const off = ((raw % tileW) + tileW) % tileW;
  g.translate(-Math.round(off), 0);
  g.fillStyle = bgPattern;

  g.fillRect(-tileW - 4, 0, W + tileW*3 + 8, H);
  g.restore();
}

/* í”Œë ˆì´ì–´ */
const player={
  x: W*0.52, y: H-128, w: 96, h: 96,
  vx:0, speed: 170,
  dir: 1,                    // 1=ì˜¤ë¥¸ìª½, -1=ì™¼ìª½
  attacking:0,
  pose: "side",              // side/front/back
  animIndex:0, animTimer:0
};
placeOnFloor();

const keys={left:false,right:false, space:false};
addEventListener('keydown',e=>{
  // ì…ë ¥ì°½ì— í¬ì»¤ìŠ¤ë©´ ê²Œì„ í‚¤ ë§‰ê¸°
  const tag = document.activeElement.tagName;
  const typing = tag==='INPUT' || tag==='TEXTAREA';

  if(e.key===' '){
    if(!typing){ e.preventDefault(); keys.space=true; }
  }
  if(['ArrowLeft','a','A'].includes(e.key) && !typing) keys.left=true;
  if(['ArrowRight','d','D'].includes(e.key) && !typing) keys.right=true;

  if(e.key==='ArrowUp' && !typing){     // ë“± ë³´ì´ê¸°
    player.pose='back'; player.attacking=0;
  }
  if(e.key==='ArrowDown' && !typing){   // ì •ë©´ ë³´ê¸°
    player.pose='front'; player.attacking=0;
  }
});
addEventListener('keyup',e=>{
  if(e.key===' ') keys.space=false;
  if(['ArrowLeft','a','A'].includes(e.key)) keys.left=false;
  if(['ArrowRight','d','D'].includes(e.key)) keys.right=false;

  if(e.key==='ArrowUp' || e.key==='ArrowDown'){
    player.pose='side';
  }
});

/* íˆ¬ì‚¬ì²´ */
const shots=[]; let shotCount=0, lastShot=0;
function shoot(){
  const now=performance.now();
  if(now-lastShot<180) return;
  lastShot=now; shotCount++;

  const big = EVERY_N_BIG>0 && (shotCount % EVERY_N_BIG===0);
  const img = big && IMGS.fireBig.complete ? IMGS.fireBig : IMGS.fireSmall;
  const size = big ? 54 : 32;
  const speed = big ? 530 : 430;

  const startX = player.dir===1 ? (player.x + player.w - 20) : (player.x + 20 - size);
  shots.push({
    x:startX, y: player.y + player.h*0.58 - size*0.5,
    vx: player.dir===1 ? speed : -speed,
    w:size, h:size, img, life: 2200
  });

  player.attacking = 140;
}

/* ì—…ë°ì´íŠ¸ */
let last=0;
function update(dt){
  // ì´ë™ + ì¹´ë©”ë¼ íŒ¨ëŸ´ë™ìŠ¤
  if(keys.left){ player.vx=-player.speed; player.dir=-1; camX-=player.speed*0.25*dt; }
  else if(keys.right){ player.vx= player.speed; player.dir= 1; camX+=player.speed*0.25*dt; }
  else { player.vx*=0.85; if(Math.abs(player.vx)<0.5) player.vx=0; }

  // ê±·ê¸° 2í”„ë ˆì„ í† ê¸€
  if(player.pose==='side' && Math.abs(player.vx)>1){
    player.animTimer += dt*1000;
    if(player.animTimer>120){ player.animTimer=0; player.animIndex = 1 - player.animIndex; }
  }else{
    player.animIndex = 0;
  }

  // ë°œì‚¬
  if(keys.space && player.pose==='side') shoot();

  player.x += player.vx*dt;
  const minX=20, maxX=W-20-player.w;
  if(player.x<minX) player.x=minX;
  if(player.x>maxX) player.x=maxX;
  if(player.attacking>0) player.attacking -= dt*1000;

  // íˆ¬ì‚¬ì²´
  for(let i=shots.length-1;i>=0;i--){
    const s=shots[i];
    s.x += s.vx*dt;
    s.life -= dt*1000;
    if(s.x<-s.w || s.x>W+s.w || s.life<=0) shots.splice(i,1);
  }
}

/* ê·¸ë¦¬ê¸° */
function draw(){
  drawBGPattern(ctx);

  // íˆ¬ì‚¬ì²´
  for(const s of shots){
    const dx=Math.round(s.x), dy=Math.round(s.y);
    if(s.img && s.img.complete){
      if(s.vx>=0) ctx.drawImage(s.img, dx, dy, s.w, s.h);
      else{
        ctx.save(); ctx.translate(dx+s.w,0); ctx.scale(-1,1);
        ctx.drawImage(s.img, 0, dy, s.w, s.h); ctx.restore();
      }
    }else{ ctx.fillStyle="#ff9a00"; ctx.fillRect(dx,dy,s.w,s.h); }
  }

  // í”Œë ˆì´ì–´
  const px=Math.round(player.x), py=Math.round(player.y);
  let img = null;
  if(player.pose==='front' && IMGS.center.complete) img = IMGS.center;
  else if(player.pose==='back' && IMGS.back.complete) img = IMGS.back;
  else{
    if(player.attacking>0 && IMGS.attack.complete) img = IMGS.attack;
    else{
      img = (Math.abs(player.vx)>1 && player.animIndex===0) ? IMGS.right : IMGS.stopRight;
    }
  }

  if(player.dir===1){
    if(img && img.complete) ctx.drawImage(img, px, py, player.w, player.h);
  }else{
    ctx.save(); ctx.translate(px+player.w,0); ctx.scale(-1,1);
    if(img && img.complete) ctx.drawImage(img, 0, py, player.w, player.h);
    ctx.restore();
  }
}

/* ë£¨í”„ */
function loop(ts){
  const dt=Math.min(0.033,(ts-last)/1000||0.016); last=ts;
  update(dt); draw();
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
</script>
</script>

<!-- Supabase SDK -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<!-- Supabase í´ë¼ì´ì–¸íŠ¸ ì§ì ‘ ì´ˆê¸°í™” -->
<script>
  const SUPABASE_URL  = "https://mgpxqmqvlbjfywbbsiwt.supabase.co"; // ë³¸ì¸ í”„ë¡œì íŠ¸ URL
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1ncHhxbXF2bGJqZnl3YmJzaXd0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3NDc3OTYsImV4cCI6MjA3ODMyMzc5Nn0.dMKOkI0Vsty6ZMOxJmfF4IAPmkKF4kPhRhjCLH0dxEk"; // Supabase anon key
  window.sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
  console.log("[supabase] client ready:", !!window.sb);
</script>



</body>
</html>
