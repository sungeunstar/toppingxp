<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ToppingXP — Login</title>

<!-- Supabase SDK + 외부 키 파일 -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="js/supabase.js"></script>

<style>
:root{
  --bg:#0a0f0a; --grid:#142714; --g:#79ff79; --g-weak:#36c436; --g-deep:#1c7a1c;
  --glow:0 0 10px rgba(121,255,121,.5),0 0 18px rgba(121,255,121,.25);
  --btn-bg:#0a140a; --btn-bg-hover:#0f1d0f;
  --text-soft:#b6ffb6; --text-hover:#d4f77c;
  --danger:#ff7272; --ok:#9bffa4;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; color:var(--g); font-family:ui-monospace, Menlo, Consolas, monospace; letter-spacing:.2px;
  /* 기본 배경 (이미지 로드 전) */
  background: radial-gradient(1100px 700px at 50% 50%, #0b160b 0%, var(--bg) 60%);
}
/* 배경 이미지 레이어 */
body::before{
  content:"";
  position:fixed; inset:0;
  background-image: url("https://i.ibb.co/jkRx69N7/level-up-bg-jpg.png"); /* <- 경로만 바꿔 */
  background-size:cover; background-position:center; background-repeat:no-repeat;
  filter: saturate(1.1) contrast(1.02);
  z-index:-2;
}
/* 어둡게/비네팅 오버레이 */
body::after{
  content:"";
  position:fixed; inset:0;
  background:
    radial-gradient(1200px 800px at 50% 40%, rgba(0,0,0,.25), rgba(0,0,0,.6) 60%, rgba(0,0,0,.85) 100%),
    linear-gradient(0deg, transparent 23px, rgba(0,0,0,.25) 24px),
    linear-gradient(90deg, transparent 23px, rgba(0,0,0,.25) 24px);
  background-size: auto, 24px 24px, 24px 24px;
  z-index:-1;
}
.wrap{min-height:100vh; display:grid; place-items:center; padding:24px}

/* 글래스 카드 */
.card{
  width:min(520px,92%); padding:20px 18px;
  background: rgba(8,18,8,.55);
  border:1px solid rgba(28,122,28,.55);
  box-shadow: 0 10px 30px rgba(0,0,0,.45), inset 0 0 0 2px rgba(28,122,28,.15);
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
  border-radius: 10px;
}
.h1{font-size:22px; font-weight:900; margin:0 0 6px; text-shadow:var(--glow)}
.sub{color:#a7ffa7; margin:0 0 14px; font-size:14px}

.row{display:grid; gap:10px; margin:12px 0}
.input{
  width:100%; padding:12px; border:2px solid var(--g-deep); background:rgba(10,19,10,.85); color:var(--g);
  box-shadow:inset 0 0 0 2px rgba(28,122,28,.18); font-size:15px; border-radius:8px;
}
.input[disabled]{opacity:.6}
.btn{
  padding:12px 14px; border:2px solid var(--g); background:rgba(10,20,10,.9); color:var(--text-soft);
  font-weight:800; cursor:pointer; box-shadow:var(--glow); line-height:1; text-align:center; border-radius:8px;
}
.btn:hover{background:var(--btn-bg-hover); color:var(--text-hover)}
.btn[disabled]{opacity:.6; cursor:not-allowed}
.help{display:flex; justify-content:space-between; align-items:center; margin-top:8px; font-size:13px; color:var(--text-soft)}
.link{color:var(--text-hover); text-decoration:underline; cursor:pointer}

.msg{margin-top:10px; font-size:13px}
.msg.ok{color:var(--ok)}
.msg.err{color:var(--danger)}

.pw-wrap{position:relative}
.togglePw{
  position:absolute; right:10px; top:50%; transform:translateY(-50%);
  font-size:12px; border:2px solid var(--g-deep); padding:3px 6px; background:#0b130b; color:var(--text-soft); cursor:pointer;
  border-radius:6px;
}
.togglePw:hover{background:#122012}

/* 회원가입 모달 */
.modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.45)}
.modal.show{display:flex}
.modalCard{
  width:min(540px,92%);
  background: rgba(9,17,9,.7);
  border:2px solid rgba(28,122,28,.6);
  box-shadow:var(--glow);
  padding:16px; display:grid; gap:12px;
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
  border-radius:10px;
}
.modalHead{display:flex; justify-content:space-between; align-items:center}
.modalBtns{display:flex; gap:8px; justify-content:flex-end}

/* 토스트 */
.toast{
  position:fixed; right:22px; bottom:22px; z-index:7000; display:none; min-width:320px;
  background:rgba(9,17,9,.9); color:var(--g); border:2px solid var(--g-deep); box-shadow:var(--glow); padding:14px 16px; border-radius:10px;
}
.toast.show{display:block; animation:toastIn .18s ease}
@keyframes toastIn{from{transform:translateY(6px); opacity:0}to{transform:translateY(0); opacity:1}}

/* 모션 민감 사용자 배려 */
@media (prefers-reduced-motion: reduce){
  body::before{filter:none}
  .toast.show{animation:none}
}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="h1">ToppingXP</div>
    <p class="sub">로그인 후 퀘스트와 회고 데이터를 저장/동기화합니다.</p>

    <div class="row">
      <input id="email" class="input" placeholder="이메일" autocomplete="email" />
      <div class="pw-wrap">
        <input id="password" class="input" type="password" placeholder="비밀번호" autocomplete="current-password" />
        <button id="togglePw" class="togglePw" type="button">보기</button>
      </div>
      <button id="signin" class="btn">로그인</button>
      <div class="help">
        <span>계정이 없나요?</span>
        <span id="openSignup" class="link">회원가입</span>
      </div>
      <div id="loginMsg" class="msg"></div>
    </div>
  </div>
</div>

<!-- Signup Modal -->
<div id="signupModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="signupTitle">
  <div class="modalCard">
    <div class="modalHead">
      <div class="h1" id="signupTitle" style="font-size:18px">회원가입</div>
      <span id="closeSignup" class="link">닫기</span>
    </div>
    <div class="sub">이메일 인증이 설정된 프로젝트라면, 메일함에서 인증 링크를 확인하세요.</div>
    <div class="row">
      <input id="su_name" class="input" placeholder="표시 이름 (예: Alex)" />
      <input id="su_email" class="input" placeholder="이메일" autocomplete="email" />
      <div class="pw-wrap">
        <input id="su_pw" class="input" type="password" placeholder="비밀번호 (최소 6자)" autocomplete="new-password" />
        <button id="togglePw2" class="togglePw" type="button">보기</button>
      </div>
      <div class="pw-wrap">
        <input id="su_pw2" class="input" type="password" placeholder="비밀번호 확인" autocomplete="new-password" />
        <button id="togglePw3" class="togglePw" type="button">보기</button>
      </div>
    </div>
    <div class="modalBtns">
      <button id="signupBtn" class="btn">가입하기</button>
    </div>
    <div id="signupMsg" class="msg"></div>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="toast"><span id="toastMsg"></span></div>

<script>
/* ===== El refs ===== */
const $ = id => document.getElementById(id);
const els = {
  email:$('email'), password:$('password'), signin:$('signin'),
  togglePw:$('togglePw'), loginMsg:$('loginMsg'),
  openSignup:$('openSignup'), closeSignup:$('closeSignup'),
  modal:$('signupModal'),
  su_name:$('su_name'), su_email:$('su_email'),
  su_pw:$('su_pw'), su_pw2:$('su_pw2'),
  togglePw2:$('togglePw2'), togglePw3:$('togglePw3'),
  signupBtn:$('signupBtn'), signupMsg:$('signupMsg'),
  toast:$('toast'), toastMsg:$('toastMsg')
};

/* ===== Utils ===== */
function showMsg(el, text, ok=false){ el.textContent=text; el.className='msg ' + (ok?'ok':'err'); }
function toast(text){ els.toastMsg.textContent=text; els.toast.classList.add('show'); setTimeout(()=>els.toast.classList.remove('show'), 1800); }
function setLoading(is){
  els.signin.disabled=is; els.signupBtn.disabled=is;
  [els.email,els.password,els.su_email,els.su_pw,els.su_pw2,els.su_name].forEach(i=>i&&(i.disabled=is));
}

/* ===== Session guard ===== */
(async function boot(){
  const { data:{ user } } = await sb.auth.getUser();
  if(user){ location.href = "index.html"; }
})();

/* ===== Login ===== */
els.togglePw.onclick = ()=>{
  const t = els.password.type === 'password' ? 'text' : 'password';
  els.password.type = t; els.togglePw.textContent = t==='text' ? '숨기기' : '보기';
};
els.signin.onclick = async ()=>{
  els.loginMsg.textContent='';
  const email = els.email.value.trim();
  const pw = els.password.value;
  if(!email || !pw){ showMsg(els.loginMsg,'이메일과 비밀번호를 입력하세요'); return; }
  try{
    setLoading(true);
    const { error } = await sb.auth.signInWithPassword({ email, password: pw });
    if(error){ showMsg(els.loginMsg, error.message); }
    else { toast('로그인 성공'); location.href = "index.html"; }
  }catch(e){
    showMsg(els.loginMsg, e.message||'로그인 실패');
  }finally{ setLoading(false); }
};
els.email.addEventListener('keydown', e=>{ if(e.key==='Enter') els.signin.click(); });
els.password.addEventListener('keydown', e=>{ if(e.key==='Enter') els.signin.click(); });

/* ===== Signup (modal) ===== */
function openSignup(){ els.modal.classList.add('show'); }
function closeSignup(){ els.modal.classList.remove('show'); els.signupMsg.textContent=''; }
els.openSignup.onclick = openSignup;
els.closeSignup.onclick = closeSignup;

[els.togglePw2, els.togglePw3].forEach((btn, i)=>{
  btn.onclick = ()=>{
    const input = i===0 ? els.su_pw : els.su_pw2;
    const t = input.type === 'password' ? 'text' : 'password';
    input.type = t; btn.textContent = t==='text' ? '숨기기' : '보기';
  };
});

els.signupBtn.onclick = async ()=>{
  els.signupMsg.textContent='';
  const name = els.su_name.value.trim();
  const email = els.su_email.value.trim();
  const pw = els.su_pw.value, pw2 = els.su_pw2.value;
  if(!email || !pw || !pw2){ showMsg(els.signupMsg,'필드를 모두 입력하세요'); return; }
  if(pw.length < 6){ showMsg(els.signupMsg,'비밀번호는 최소 6자'); return; }
  if(pw !== pw2){ showMsg(els.signupMsg,'비밀번호가 일치하지 않습니다'); return; }

  try{
    setLoading(true);
    const { data, error } = await sb.auth.signUp({
      email, password: pw,
      options:{ data:{ display_name: name||null } }
    });
    if(error){ showMsg(els.signupMsg, error.message); return; }

    // profiles에 표시이름 저장 (세션이 있으면 즉시)
    if(data.user && data.session){
      await sb.from('profiles').upsert({ id:data.user.id, display_name: name||email.split('@')[0] });
    }

    const needsConfirm = !data.session;
    if(needsConfirm){
      showMsg(els.signupMsg,'가입 완료. 이메일 인증 후 로그인하세요.', true);
      toast('인증 메일을 확인하세요');
    }else{
      showMsg(els.signupMsg,'가입 및 로그인 완료', true);
      toast('환영합니다!');
      location.href = "index.html";
    }
    setTimeout(()=>closeSignup(), needsConfirm?1600:600);
  }catch(e){
    showMsg(els.signupMsg, e.message||'가입 실패');
  }finally{ setLoading(false); }
};

['su_email','su_pw','su_pw2','su_name'].forEach(id=>{
  $(id).addEventListener('keydown', e=>{ if(e.key==='Enter') els.signupBtn.click(); });
});
</script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="js/supabase.js"></script>
</body>
</html>
