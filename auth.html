<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Supabase 로그인 테스트</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <!-- env.js 를 먼저 불러와야 함 -->
  <script src="./env.js"></script>
  <style>
    body{margin:0;background:#0b0c0f;color:#e7e9ee;font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,sans-serif}
    .wrap{max-width:420px;margin:48px auto;padding:0 16px}
    .card{background:#13161a;border:1px solid #23262e;border-radius:12px;padding:20px}
    input,button{width:100%;padding:12px;border-radius:8px;border:1px solid #2a2f39;background:#0f1216;color:#e7e9ee}
    input{margin-top:8px}
    button{cursor:pointer;margin-top:8px}
    .muted{color:#9aa4b2;font-size:12px;margin-top:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div id="auth-box">
        <h2>이메일 로그인</h2>
        <input id="email" type="email" placeholder="이메일" autocomplete="username">
        <input id="password" type="password" placeholder="비밀번호(6자 이상)" autocomplete="current-password">
        <button id="btn-signin">로그인</button>
        <button id="btn-signup">회원가입</button>
        <p class="muted" id="msg"></p>
      </div>

      <div id="user-box" style="display:none">
        <h3 id="who"></h3>
        <button id="btn-signout">로그아웃</button>
      </div>
    </div>
  </div>

<script>
const { url, anonKey } = window.__SUPABASE__
const supabase = window.supabase.createClient(url, anonKey)

const $ = (id) => document.getElementById(id)
const msg = $('msg'), authBox = $('auth-box'), userBox = $('user-box'), who = $('who')

const uiSignedIn = (user) => {
  authBox.style.display = 'none'
  userBox.style.display = 'block'
  who.textContent = `로그인됨: ${user.email}`
}
const uiSignedOut = () => {
  authBox.style.display = 'block'
  userBox.style.display = 'none'
  msg.textContent = ''
}

// 기존 세션 확인
supabase.auth.getUser().then(({ data }) => {
  if (data?.user) uiSignedIn(data.user); else uiSignedOut()
})

// 상태 변경 리스너
supabase.auth.onAuthStateChange((_evt, session) => {
  if (session?.user) uiSignedIn(session.user); else uiSignedOut()
})

$('btn-signup').addEventListener('click', async () => {
  msg.textContent = ''
  const { error } = await supabase.auth.signUp({
    email: $('email').value,
    password: $('password').value
  })
  msg.textContent = error ? error.message : '회원가입 완료. 이메일 확인이 필요할 수 있어요.'
})

$('btn-signin').addEventListener('click', async () => {
  msg.textContent = ''
  const { data, error } = await supabase.auth.signInWithPassword({
    email: $('email').value,
    password: $('password').value
  })
  if (error) { msg.textContent = error.message; return }
  uiSignedIn(data.user)
})

$('btn-signout').addEventListener('click', async () => {
  await supabase.auth.signOut()
  uiSignedOut()
})
</script>
</body>
</html>
