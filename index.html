<!DOCTYPE html>
<html lang="ko">
<head>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ToppingXP â€” Quests</title>
<style>
:root{
  --bg:#0a0f0a; --grid:#142714; --g:#79ff79; --g-weak:#36c436; --g-deep:#1c7a1c;
  --scan:rgba(121,255,121,.06);
  --glow:0 0 10px rgba(121,255,121,.5),0 0 18px rgba(121,255,121,.25);
  --btn-bg:#0a140a; --btn-bg-hover:#0f1d0f;
  --text-soft:#b6ffb6; --text-hover:#d4f77c;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; background:radial-gradient(1100px 700px at 50% 50%, #0b160b 0%, var(--bg) 60%);
  color:var(--g); font-family: ui-monospace, Menlo, Consolas, monospace; letter-spacing:.2px; font-size:16px;
}
.app{position:relative; height:100%; display:grid; grid-template-columns: 1.15fr .85fr; gap:2px}
.panel{
  position:relative; padding:18px 16px;
  background:
   linear-gradient(0deg, transparent 23px, var(--grid) 24px),
   linear-gradient(90deg, transparent 23px, var(--grid) 24px);
  background-size:24px 24px;
  border:1px solid var(--g-deep);
  box-shadow:inset 0 0 0 2px rgba(28,122,28,.2);
}
.app.crt::after{
  content:""; position:absolute; inset:0;
  background:repeating-linear-gradient(0deg,var(--scan) 0 2px, transparent 2px 4px);
  mix-blend-mode:screen; pointer-events:none;
  animation:scan 6s linear infinite, flicker 2.8s steps(60) infinite;
}
@keyframes scan{0%{opacity:.25}50%{opacity:.18}100%{opacity:.25}}
@keyframes flicker{50%{filter:brightness(1.04)}}

.h1{font-size:20px; margin:0 0 2px; text-shadow:var(--glow); font-weight:800}
.sub{color:var(--g-weak); margin:0 0 12px; font-size:14px}
.date{font-size:12px; color:#a6ffa6; margin-bottom:10px}

.inputRow{display:flex; gap:10px; margin:10px 0 12px}
.input{
  flex:1; padding:12px 12px; border:2px solid var(--g-deep); background:#0a130a; color:var(--g);
  box-shadow:inset 0 0 0 2px rgba(28,122,28,.18); font-size:15px
}
.btn{
  padding:12px 14px; border:2px solid var(--g); background:var(--btn-bg); color:var(--text-soft);
  font-weight:800; cursor:pointer; box-shadow:var(--glow); line-height:1; min-width:68px; text-align:center
}
.btn:hover,.btn:focus{background:var(--btn-bg-hover); color:var(--text-hover); outline:none}

.list{display:flex; flex-direction:column; gap:10px; min-height:140px}
.card{
  border:2px solid var(--g-deep); background:rgba(0,0,0,.08); padding:10px 12px;
  display:grid; grid-template-columns:auto 1fr auto; gap:10px; align-items:center;
  box-shadow:inset 0 0 0 2px rgba(28,122,28,.15);
}
.badge{font-size:12px; padding:3px 8px; border:2px solid var(--g-deep)}
.title{overflow:hidden; text-overflow:ellipsis; white-space:nowrap; font-size:15px}
.row{display:flex; gap:8px; align-items:center}
.iconbtn{
  border:2px solid var(--g-deep); padding:7px 9px; cursor:pointer; background:#0b130b; color:var(--text-soft);
  transition:transform .02s, background .15s
}
.iconbtn:hover{background:#122012}
.iconbtn:active{transform:translateY(1px)}
.done .title{text-decoration:line-through; opacity:.75}
.done{border-color:var(--g)}

.rightGrid{display:grid; grid-template-rows:auto auto 1fr auto; gap:14px; height:100%}
.box{
  border:2px solid var(--g-deep); padding:12px; box-shadow:inset 0 0 0 2px rgba(29,122,29,.18);
}
.statTop{display:flex; justify-content:space-between; gap:10px; align-items:center; margin-bottom:8px}
.kebab{position:relative; z-index:5000}
.kebabBtn{
  border:2px solid var(--g-deep); background:#0b130b; color:var(--text-soft);
  padding:8px 10px; cursor:pointer; font-weight:800;
}
.kebabBtn:hover{background:#122012}
.kebabMenu{
  position:absolute; right:0; top:40px; min-width:160px; display:none;
  background:#0a130a; border:2px solid var(--g-deep); box-shadow:var(--glow); z-index:6000;
}
.kebabMenu.show{display:block}
.kebabMenu button{
  width:100%; text-align:left; padding:10px 12px; background:transparent; border:0; color:var(--text-soft); cursor:pointer;
}
.kebabMenu button:hover{background:#122012; color:var(--text-hover)}

.small{font-size:12px; color:var(--g-weak)}
.statGrid{display:grid; grid-template-columns:repeat(3,1fr); gap:10px}
.slab{display:grid; place-items:center; min-height:62px; font-weight:800; font-size:15px}

.bars{display:grid; gap:10px}
.bar{position:relative; border:2px solid var(--g-deep); height:26px; box-shadow:inset 0 0 0 2px rgba(29,122,29,.18)}
.bar>span{position:absolute; inset:0 auto 0 0; width:0; background:linear-gradient(90deg, rgba(121,255,121,.55), rgba(121,255,121,.9))}
.barlabel{position:absolute; inset:0; display:flex; justify-content:space-between; align-items:center; padding:0 10px; font-weight:800}

.storeTop{display:grid; grid-template-columns:1fr auto auto; gap:10px; align-items:center; margin-bottom:8px}
.storeTop .input{padding:10px}
.storeGrid{display:grid; grid-template-columns:repeat(3,1fr); gap:10px}
.storeItem{border:2px solid var(--g-deep); padding:10px; display:grid; gap:10px; text-align:center;
  box-shadow:inset 0 0 0 2px rgba(29,122,29,.18)}
.storeItem .name{font-weight:800}
.storeItem .cost{font-weight:800}
.miniRow{display:flex; gap:6px; justify-content:center}
.mini{border:2px solid var(--g-deep); background:#0b130b; color:var(--text-soft); padding:6px 8px; cursor:pointer; font-size:12px}
.mini:hover{background:#122012}
.storeItem .buy{border:2px solid var(--g); padding:8px 10px; cursor:pointer; background:var(--btn-bg); color:var(--text-soft); font-weight:800}
.storeItem .buy:hover{background:var(--btn-bg-hover); color:var(--text-hover)}

.flash{animation:flash .6s ease}
@keyframes flash{0%{box-shadow:0 0 0 0 rgba(121,255,121,0)}60%{box-shadow:0 0 18px 6px rgba(121,255,121,.35)}100%{box-shadow:0 0 0 0 rgba(121,255,121,0)}}

/* íšŒê³  ëª¨ë‹¬ (ë²„íŠ¼ í´ë¦­ ì‹œì—ë§Œ ì—´ë¦¼) */
.modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.45)}
.modal.show{display:flex}
.modalCard{width:min(520px,92%); background:#091109; color:var(--g); border:2px solid var(--g-deep); box-shadow:var(--glow); padding:16px; display:grid; gap:12px}
.modalCard textarea,.modalCard input{width:100%; padding:10px; border:2px solid var(--g-deep); background:rgba(0,0,0,.15); color:var(--g)}
.modalBtns{display:flex; gap:8px; justify-content:flex-end}

/* ì˜¤ë¥¸ìª½ í•˜ë‹¨ í† ìŠ¤íŠ¸ */
.toast{
  position:fixed; right:22px; bottom:22px; z-index:7000;
  display:none; min-width:320px;
  background:#091109; color:var(--g);
  border:2px solid var(--g-deep); box-shadow:var(--glow);
  padding:14px 16px;
}
.toast.show{ display:block; animation:toastIn .18s ease }
.toast .tmsg{ font-weight:800; margin-bottom:6px }
.toast .tdesc{ font-size:13px; color:var(--text-soft); margin-bottom:10px }
.toast .tbtns{ display:flex; gap:8px; justify-content:flex-end }
@keyframes toastIn{ from{ transform:translateY(6px); opacity:0 } to{ transform:translateY(0); opacity:1 } }

/* ì´ˆê¸°í™” ì¶•í•˜ ì˜¤ë²„ë ˆì´ */
#seasonOverlay{
  position:fixed; inset:0; display:none; align-items:center; justify-content:center;
  background:radial-gradient(ellipse at center, rgba(160,255,160,.15), rgba(0,0,0,.7) 70%);
  z-index:9999; pointer-events:none;
}
#seasonOverlay.show{display:flex; animation:fadeOut 1.8s ease forwards 1.2s}
#seasonOverlay .msg{
  color:#d6ffd6; font-size:28px; font-weight:900; letter-spacing:.6px; text-shadow:var(--glow);
  animation:punch .6s ease;
}
@keyframes punch{0%{transform:scale(.7); opacity:.0}60%{transform:scale(1.1); opacity:1}100%{transform:scale(1)}}
@keyframes fadeOut{to{opacity:0}}

/* íŒŒí‹°í´ */
.particle{
  position:fixed; width:6px; height:6px; border:2px solid #9bff9b; border-radius:50%;
  box-shadow:0 0 8px rgba(155,255,155,.7); z-index:9999; pointer-events:none;
  animation:fall 1.6s ease-in forwards;
}
@keyframes fall{0%{transform:translateY(-20px) scale(1); opacity:1}100%{transform:translateY(90vh) scale(.7); opacity:0}}

@media(max-width:980px){
  .app{grid-template-columns:1fr}
  .storeGrid{grid-template-columns:1fr 1fr}
}
</style>
</head>
<body>
<div class="app crt" id="app">
  <div id="seasonOverlay"><div class="msg">ìƒˆ ì‹œì¦Œì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!</div></div>

  <!-- LEFT -->
  <section class="panel">
    <div class="h1">Quests</div>
    <div class="date" id="today"></div>
    <div class="sub" id="greet"></div>

    <p class="sub">í•œ ì¤„ í€˜ìŠ¤íŠ¸ ì…ë ¥ í›„ <b>Enter</b> ë˜ëŠ” <b>ì¶”ê°€</b> ë²„íŠ¼ìœ¼ë¡œ ë“±ë¡. ì™„ë£Œí•  ë•Œë§ˆë‹¤ ì˜¤ë¥¸ìª½ì— ì•ˆë‚´ê°€ ëœ¹ë‹ˆë‹¤.</p>

    <div class="inputRow">
      <input id="input" class="input" placeholder="ì˜ˆ) ê³ ê° ì¸í„°ë·° ì¼ì • í™•ì • ë©”ì¼ ë³´ë‚´ê¸°" />
      <button id="add" class="btn">ì¶”ê°€</button>
    </div>

    <div id="list" class="list" aria-live="polite"></div>
  </section>

  <!-- RIGHT -->
  <section class="panel">
    <div class="h1">Status</div>

    <div class="rightGrid">
      <div class="box">
        <div class="statTop">
          <div class="small">ì§„í–‰ í˜„í™©</div>
          <div class="kebab" id="kebab">
            <button class="kebabBtn" id="kebabBtn" aria-haspopup="true" aria-expanded="false">â‹¯</button>
            <div class="kebabMenu" id="kebabMenu" role="menu">
              <button id="resetToday" role="menuitem">ì˜¤ëŠ˜ ë¦¬ì…‹</button>
              <button id="resetAll" role="menuitem">ì „ì²´ ë¦¬ì…‹</button>
            </div>
          </div>
        </div>
        <div class="statGrid">
          <div class="slab"><div>LEVEL&nbsp;<span id="level">1</span></div></div>
          <div class="slab"><div>XP&nbsp;<span id="xp">0</span>/100</div></div>
          <div class="slab"><div>COINS&nbsp;<span id="coins">0</span></div></div>
        </div>
      </div>

      <div class="box">
        <div class="bars">
          <div class="bar"><span id="xpbar"></span><div class="barlabel"><span>XP</span><span id="xpPct">0%</span></div></div>
          <div class="bar"><span id="dailybar"></span><div class="barlabel"><span>DAILY</span><span id="dailyPct">0%</span></div></div>
        </div>
        <div class="small" id="streak" style="margin-top:6px">Streak 0 day</div>
      </div>

      <div class="box" id="logbox">
        <div class="h1" style="font-size:18px">Activity Log</div>
        <div class="small" id="log">ì•„ì§ ê¸°ë¡ ì—†ìŒ</div>
      </div>

      <div class="box">
        <div class="h1" style="font-size:18px">Reward Store</div>
        <div class="storeTop">
          <input id="rewardName" class="input" placeholder="ë¦¬ì›Œë“œ ì´ë¦„ (ì˜ˆ: ì‚°ì±… 20ë¶„)" />
          <input id="rewardCost" class="input" inputmode="numeric" placeholder="ì½”ì¸" style="max-width:120px" />
          <button id="rewardAdd" class="btn">ì¶”ê°€</button>
        </div>
        <div class="storeGrid" id="store"></div>
      </div>
    </div>
  </section>
</div>

<!-- Retrospect Modal (ë²„íŠ¼ ëˆŒë €ì„ ë•Œë§Œ ì—´ë¦¼) -->
<div class="modal" id="retroModal" role="dialog" aria-modal="true" aria-labelledby="retroTitle">
  <div class="modalCard">
    <div class="h1" id="retroTitle">ì˜¤ëŠ˜ì˜ íšŒê³ </div>
    <input id="rDone" placeholder="âœ… ì˜¤ëŠ˜ ëë‚¸ ì¼ í•œ ì¤„" />
    <textarea id="rFeel" rows="3" placeholder="ğŸ’­ ëŠë‚€ ì "></textarea>
    <input id="rNext" placeholder="ğŸ” ë‚´ì¼ ì´ì–´ê°ˆ í¬ì¸íŠ¸" />
    <div class="modalBtns">
      <button id="rCancel" class="btn">ë‚˜ì¤‘ì—</button>
      <button id="rSave" class="btn">ì €ì¥</button>
    </div>
  </div>
</div>

<!-- ì˜¤ë¥¸ìª½ í•˜ë‹¨ ì•ˆë‚´ í† ìŠ¤íŠ¸ -->
<div id="retroToast" class="toast" role="status" aria-live="polite">
  <div class="tmsg" id="toastTitle">ì™„ë£Œí–ˆìŠµë‹ˆë‹¤!</div>
  <div class="tdesc">íšŒê³ ë¡ì„ ì—¬ì‹œê² ì–´ìš”?</div>
  <div class="tbtns">
    <button id="tLater" class="btn">ë‚˜ì¤‘ì—</button>
    <button id="tOpen"  class="btn">ì—´ê¸°</button>
  </div>
</div>

<!-- Reward Toast -->
<div id="buyToast" class="toast" role="status" aria-live="polite" style="bottom:92px">
  <div class="tmsg">ë³´ìƒ êµ¬ë§¤ ì™„ë£Œ!</div>
  <div class="small">ì¦ê¸°ì„¸ìš”!</div>
</div>

<script>
/* storage helpers */
const LS = key => ({ get:() => JSON.parse(localStorage.getItem(key)||'null'), set:v => localStorage.setItem(key,JSON.stringify(v)) });
const store = { quests:LS('quests'), meta:LS('meta'), retro:LS('retro'), rewards:LS('rewards') };
const todayKey = () => new Date().toISOString().slice(0,10);

/* defaults */
const defaults = [
  { id:'coffee', name:'í•¸ë“œë“œë¦½ ì»¤í”¼ 1ì”', cost:80 },
  { id:'video', name:'ì˜ìƒ 30ë¶„ ê°ìƒ', cost:60 },
  { id:'walk',  name:'ì‚°ì±… 20ë¶„', cost:40 },
  { id:'game',  name:'ê²Œì„ 30ë¶„', cost:90 },
  { id:'book',  name:'ì±… êµ¬ì… 1ë§Œì›', cost:500 },
  { id:'treat', name:'ë§›ìˆëŠ” ê°„ì‹', cost:120 }
];

/* state */
const state = {
  quests: store.quests.get() || [],
  meta: store.meta.get() || { xp:0, level:1, coins:0, streak:0, lastClear:null, selected:null, stats:{} },
  retro: store.retro.get() || {},
  rewards: store.rewards.get() || defaults.slice()
};
if(!state.meta.stats[todayKey()]) state.meta.stats[todayKey()] = { total:0, done:0 };

/* els */
const $ = id => document.getElementById(id);
const els = {
  today: $('today'),
  list: $('list'),
  input: $('input'),
  add: $('add'),
  xp: $('xp'),
  level: $('level'),
  coins: $('coins'),
  xpbar: $('xpbar'),
  xpPct: $('xpPct'),
  dailybar: $('dailybar'),
  dailyPct: $('dailyPct'),
  log: $('log'),
  logbox: $('logbox'),
  streak: $('streak'),
  store: $('store'),
  modal: $('retroModal'),
  rDone: $('rDone'),
  rFeel: $('rFeel'),
  rNext: $('rNext'),
  rSave: $('rSave'),
  rCancel: $('rCancel'),
  rewardName: $('rewardName'),
  rewardCost: $('rewardCost'),
  rewardAdd: $('rewardAdd'),
  kebab: document.getElementById('kebab'),
  kebabBtn: $('kebabBtn'),
  kebabMenu: $('kebabMenu'),
  resetToday: $('resetToday'),
  resetAll: $('resetAll'),
  overlay: $('seasonOverlay'),
  // toasts
  retroToast: $('retroToast'),
  toastTitle: $('toastTitle'),
  tOpen: $('tOpen'),
  tLater: $('tLater'),
  buyToast: $('buyToast')
};

/* audio */
function blip(freq=880,ms=120){
  try{
    const ac = new (window.AudioContext||window.webkitAudioContext)();
    const o = ac.createOscillator(); const g = ac.createGain();
    o.type='square'; o.frequency.value=freq; o.connect(g); g.connect(ac.destination);
    o.start(); g.gain.exponentialRampToValueAtTime(0.0001, ac.currentTime + ms/1000); setTimeout(()=>ac.close(), ms+80);
  }catch(e){}
}

/* helpers */
function save(){ store.quests.set(state.quests); store.meta.set(state.meta); store.retro.set(state.retro); store.rewards.set(state.rewards); }
function log(msg){
  const now = new Date();
  const line = `[${now.toTimeString().slice(0,5)}] ${msg}`;
  const prev = els.log.textContent === 'ì•„ì§ ê¸°ë¡ ì—†ìŒ' ? '' : els.log.textContent + ' ';
  els.log.textContent = prev + line;
  els.logbox.classList.add('flash'); setTimeout(()=>els.logbox.classList.remove('flash'),600);
}
function gainXP(n=10){
  const before = state.meta.xp % 100;
  state.meta.xp += n;
  state.meta.coins += n;
  if((state.meta.xp % 100) < before){ state.meta.level += 1; log(`Level Up! â†’ ${state.meta.level}`); blip(1200,150); }
  else blip(980,110);
}

/* prune yesterday data (keep only today quests visible) */
function pruneOldQuests(){
  const t = todayKey();
  const before = state.quests.length;
  state.quests = state.quests.filter(q=>q.date===t);
  if(before !== state.quests.length) log('ì§€ë‚œ ë‚ ì§œ í€˜ìŠ¤íŠ¸ê°€ ì •ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
  if(!state.meta.stats[t]) state.meta.stats[t] = { total:0, done:0 };
}

/* quests */
function addQuest(text){
  const t = text.trim(); if(!t) return;
  const q = { id: crypto.randomUUID(), text:t, date: todayKey(), doing:false, done:false, rewarded:false, createdAt: Date.now() };
  state.quests.unshift(q);
  state.meta.stats[todayKey()].total++;
  state.meta.selected = q.id;
  log(`Added: ${t}`);
  save(); render();
}
function showRetroToast(message){
  els.toastTitle.textContent = message || 'ì™„ë£Œí–ˆìŠµë‹ˆë‹¤!';
  els.retroToast.classList.add('show');
}
function hideRetroToast(){ els.retroToast.classList.remove('show'); }

function toggleDone(q){
  if(q.done){
    q.done=false; log(`Reopened: ${q.text}`);
  }else{
    q.done=true; q.doing=false;
    if(!q.rewarded){ q.rewarded=true; gainXP(10); }
    log(`Completed: ${q.text} (+10 XP once)`);
    // âœ… ëª¨ë‹¬ ìë™ ì˜¤í”ˆ ê¸ˆì§€: ì˜¤ë¥¸ìª½ í† ìŠ¤íŠ¸ë§Œ ë„ì›€
    showRetroToast(`â€˜${q.text}â€™ ì™„ë£Œ!`);
  }
  const today = todayKey();
  const todayItems = state.quests.filter(x=>x.date===today);
  const allDone = todayItems.length>0 && todayItems.every(x=>x.done);
  if(allDone && state.meta.lastClear !== today){
    state.meta.streak += 1; state.meta.lastClear = today;
    log(`All quests cleared! Streak +1 â†’ ${state.meta.streak}`);
    // ì „ë¶€ ì™„ë£Œí•´ë„ ëª¨ë‹¬ì€ ìë™ ì˜¤í”ˆí•˜ì§€ ì•ŠìŒ (ìš”ì²­ì‚¬í•­)
  }
  save(); render();
}

/* rewards */
function addReward(name, cost){
  const n = name.trim();
  const c = Number(cost);
  if(!n || !Number.isFinite(c) || c<=0){ blip(250,160); return; }
  state.rewards.unshift({ id: crypto.randomUUID(), name:n, cost:Math.floor(c) });
  log(`Reward ì¶”ê°€: ${n} (${Math.floor(c)} ì½”ì¸)`); save(); renderStore();
}
function showBuyToast(){ els.buyToast.classList.add('show'); setTimeout(()=>els.buyToast.classList.remove('show'), 1600); }
function buyReward(r){
  if(state.meta.coins < r.cost){ log(`ì½”ì¸ì´ ë¶€ì¡±í•©ë‹ˆë‹¤ (${r.name})`); blip(220,160); return; }
  state.meta.coins -= r.cost; log(`Reward ì‚¬ìš©: ${r.name} (-${r.cost} ì½”ì¸)`); blip(700,150);
  showBuyToast();
  save(); renderStats(); renderStore();
}
function editReward(r){
  const n = prompt('ë¦¬ì›Œë“œ ì´ë¦„', r.name); if(n===null) return;
  const c = prompt('í•„ìš” ì½”ì¸', r.cost); if(c===null) return;
  const cost = Number(c);
  if(!n.trim() || !Number.isFinite(cost) || cost<=0){ blip(250,160); return; }
  r.name = n.trim(); r.cost = Math.floor(cost);
  log(`Reward ìˆ˜ì •: ${r.name} (${r.cost} ì½”ì¸)`); save(); renderStore();
}
function deleteReward(id){
  state.rewards = state.rewards.filter(x=>x.id!==id);
  log('Reward ì‚­ì œ ì™„ë£Œ'); save(); renderStore();
}

/* kebab (ì  ë©”ë‰´) */
function toggleKebab(show){
  const willShow = typeof show==='boolean' ? show : !els.kebabMenu.classList.contains('show');
  els.kebabMenu.classList.toggle('show', willShow);
  els.kebabBtn.setAttribute('aria-expanded', willShow ? 'true' : 'false');
}
els.kebabBtn.addEventListener('click',(e)=>{ e.stopPropagation(); toggleKebab(); });
document.addEventListener('click',(e)=>{
  if(!els.kebab.contains(e.target)) toggleKebab(false);
});

/* reset */
function resetToday(){
  if(!confirm('ì˜¤ëŠ˜ í€˜ìŠ¤íŠ¸ë¥¼ ëª¨ë‘ ì´ˆê¸°í™”í• ê¹Œìš”?')) return;
  const t = todayKey();
  state.quests = state.quests.filter(q=>q.date!==t);
  delete state.retro[t];
  state.meta.stats[t] = { total:0, done:0 };
  state.meta.selected = null;
  save(); render(); log('ì˜¤ëŠ˜ ë°ì´í„° ì´ˆê¸°í™” ì™„ë£Œ');
  celebrateReset(false);
}
function resetAll(){
  if(!confirm('ì •ë§ ëª¨ë“  ë°ì´í„°ë¥¼ ì™„ì „íˆ ì´ˆê¸°í™”í• ê¹Œìš”? (XP / LEVEL í¬í•¨)')) return;

  localStorage.clear();

  state.quests = [];
  state.meta = {
    xp: 0,
    level: 1,
    coins: 0,
    streak: 0,
    lastClear: null,
    selected: null,
    stats: {}
  };
  state.retro = {};
  state.rewards = defaults.slice();

  save(); render();
  log('ì „ì²´ ì´ˆê¸°í™” ì™„ë£Œ â€” XP, ë ˆë²¨, ì½”ì¸, ìŠ¤íŠ¸ë¦­ ëª¨ë‘ ë¦¬ì…‹ë˜ì—ˆìŠµë‹ˆë‹¤.');
  blip(500,200);
  celebrateReset(true);
}

/* ì´ˆê¸°í™” ì¶•í•˜ ì—°ì¶œ */
function celebrateReset(full=true){
  try{
    els.overlay.classList.remove('show'); void els.overlay.offsetWidth;
    els.overlay.querySelector('.msg').textContent = full ? 'ìƒˆ ì‹œì¦Œì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!' : 'ìƒˆë¡œìš´ í•˜ë£¨ê°€ ì‹œì‘ë˜ì—ˆë„¤ìš”! ì˜¤ëŠ˜ì˜ í€˜ìŠ¤íŠ¸ë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”!';
    els.overlay.classList.add('show');
    for(let i=0;i<22;i++){
      const p=document.createElement('div'); p.className='particle';
      const x=Math.random()*95+2; const delay=Math.random()*0.6;
      p.style.left = x+'vw'; p.style.top='-10px'; p.style.animationDelay=delay+'s';
      document.body.appendChild(p);
      setTimeout(()=>p.remove(), 2000);
    }
  }catch(e){}
}

/* render */
function render(){
  els.today.textContent = new Date().toLocaleDateString('ko-KR',{year:'numeric',month:'2-digit',day:'2-digit',weekday:'short'});
  renderQuests(); renderStats(); renderStore();
}
function renderQuests(){
  els.list.innerHTML = '';
  const today = todayKey();
  const todayItems = state.quests.filter(q => q.date === today);
  state.meta.stats[today].total = todayItems.length;
  let doneCount = 0;

  todayItems.forEach(q=>{
    if(q.done) doneCount++;
    const row = document.createElement('div');
    row.className = 'card' + (q.done ? ' done' : '') + (state.meta.selected===q.id ? ' flash' : '');
    row.tabIndex = 0;

    const badge = document.createElement('div'); badge.className='badge'; badge.textContent = q.done ? 'DONE' : (q.doing?'DOING':'TODO');
    const title = document.createElement('div'); title.className='title'; title.textContent=q.text;

    const actions = document.createElement('div'); actions.className='row';
    const bDo = mkBtn('ì§„í–‰','Doing',()=>{q.doing=true; q.done=false; log(`Started: ${q.text}`); save(); render();});
    const bDone = mkBtn('ì™„ë£Œ','Complete',()=>toggleDone(q));
    const bDel = mkBtn('ì‚­ì œ','Delete',()=>{ state.quests = state.quests.filter(x=>x.id!==q.id); log(`Deleted: ${q.text}`); save(); render(); });
    actions.append(bDo,bDone,bDel);

    row.onclick = ()=> state.meta.selected = q.id;
    row.append(badge,title,actions);
    els.list.append(row);
  });

  state.meta.stats[today].done = doneCount;

  if(!todayItems.length) els.list.innerHTML = `<div class="small">ì˜¤ëŠ˜ í€˜ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. ìœ„ ì…ë ¥ì°½ì—ì„œ ì¶”ê°€í•˜ì„¸ìš”.</div>`;
}
function renderStats(){
  const xp100 = state.meta.xp % 100;
  els.xp.textContent = xp100;
  els.level.textContent = state.meta.level;
  els.coins.textContent = state.meta.coins;
  const xpPct = Math.min(100, Math.floor(xp100));
  els.xpbar.style.width = xpPct + '%';
  els.xpPct.textContent = xpPct + '%';

  const today = todayKey();
  const todayItems = state.quests.filter(q => q.date === today);
  const doneCount = todayItems.filter(q=>q.done).length;
  const dailyPct = todayItems.length ? Math.floor(doneCount / todayItems.length * 100) : 0;
  els.dailybar.style.width = dailyPct + '%';
  els.dailyPct.textContent = dailyPct + '%';
  els.streak.textContent = `Streak ${state.meta.streak} day`;
}
function renderStore(){
  els.store.innerHTML='';
  state.rewards.forEach(item=>{
    const wrap = document.createElement('div'); wrap.className='storeItem';
    wrap.innerHTML = `<div class="name">${item.name}</div><div class="cost">${item.cost} ì½”ì¸</div>`;
    const buy = document.createElement('button'); buy.className='buy'; buy.textContent='BUY';
    buy.onclick = ()=> buyReward(item);

    const row = document.createElement('div'); row.className='miniRow';
    const edit = document.createElement('button'); edit.className='mini'; edit.textContent='ìˆ˜ì •'; edit.onclick = ()=> editReward(item);
    const del = document.createElement('button'); del.className='mini'; del.textContent='ì‚­ì œ'; del.onclick = ()=> deleteReward(item.id);
    row.append(edit,del);

    wrap.append(buy,row);
    els.store.append(wrap);
  });
}
function mkBtn(txt, title, on){
  const d=document.createElement('div'); d.className='iconbtn'; d.textContent=txt; d.title=title; d.onclick=on; return d;
}

/* events */
els.add.onclick = ()=>{ addQuest(els.input.value); els.input.value=''; els.input.focus(); };
els.input.addEventListener('keydown',e=>{
  if(e.key==='Enter'){ e.preventDefault(); els.add.click(); }
});
els.rewardAdd.onclick = ()=>{
  addReward(els.rewardName.value, els.rewardCost.value);
  els.rewardName.value=''; els.rewardCost.value='';
  els.rewardName.focus();
};

/* íšŒê³  ëª¨ë‹¬/í† ìŠ¤íŠ¸ */
function openRetro(){
  els.modal.classList.add('show');
  els.rDone.value=''; els.rFeel.value=''; els.rNext.value='';
  setTimeout(()=>els.rDone.focus(),10);
}
function closeRetro(){ els.modal.classList.remove('show'); }
els.rCancel.onclick = ()=> closeRetro();
els.rSave.onclick = ()=>{
  const date = todayKey();
  state.retro[date] = { done:els.rDone.value.trim(), feel:els.rFeel.value.trim(), next:els.rNext.value.trim(), ts:Date.now() };
  log(`Retrospect saved for ${date}`);
  save(); closeRetro();
};
els.tOpen.onclick  = ()=>{ hideRetroToast(); openRetro(); };
els.tLater.onclick = ()=> hideRetroToast();

/* kebab actions */
els.resetToday.onclick = resetToday;
els.resetAll.onclick = resetAll;

/* init */
document.addEventListener('keydown',(e)=>{ if(e.key==='Escape' && els.modal.classList.contains('show')) closeRetro(); });
els.today.textContent = new Date().toLocaleDateString('ko-KR',{year:'numeric',month:'2-digit',day:'2-digit',weekday:'short'});

/* ì²« ë¡œë“œ: ì§€ë‚œ ë‚ ì§œ í€˜ìŠ¤íŠ¸ ìë™ ì •ë¦¬ */
pruneOldQuests();
render();


</script>

<!-- âœ… ë¡œê·¸ì¸ ì¸ì¦ í™•ì¸ ì½”ë“œ -->
<script type="module">
  import { createClient } from "https://unpkg.com/@supabase/supabase-js@2";

  const supabase = createClient("https://YOUR-PROJECT.supabase.co", "YOUR-ANON-KEY");

  async function loadUser() {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) {
      // ë¡œê·¸ì¸ ì•ˆ ëœ ìƒíƒœë©´ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë³´ëƒ„
      window.location.href = "login.html";
      return;
    }

    // í”„ë¡œí•„ í…Œì´ë¸”ì—ì„œ ë‹‰ë„¤ì„ ë¶ˆëŸ¬ì˜¤ê¸°
    const { data, error } = await supabase.from("profiles").select("*").eq("id", user.id).single();
    const name = data?.display_name || user.email.split("@")[0];

    // ë‚ ì§œ ë°‘ì— ì¸ì‚¬ ë¬¸êµ¬ ì¶”ê°€
    const greetEl = document.createElement("div");
    greetEl.className = "sub";
    greetEl.textContent = `${name}ë‹˜ ì•ˆë…•í•˜ì„¸ìš”, ì˜¤ëŠ˜ë„ ì¦ê±°ìš´ ë ˆë²¨ì—… ë˜ì„¸ìš” :)`;
    document.getElementById("today").after(greetEl);
  }

  loadUser();
</script>
<script>
/* =========================
   0) Supabase ì„¤ì •
========================= */
const SUPABASE_URL = "https://YOUR-PROJECT.supabase.co";   // â† êµì²´
const SUPABASE_ANON_KEY = "YOUR-ANON-PUBLIC-KEY";          // â† êµì²´
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* =========================
   1) DB ìŠ¤í‚¤ë§ˆ (í•œ ë²ˆë§Œ ì‹¤í–‰)
   - ì•„ë˜ SQLì„ Supabase SQL Editorì—ì„œ ì´ë¯¸ ì‹¤í–‰í–ˆë‹¤ê³  ê°€ì •
   quests(user_id, text, date, doing, done, rewarded)
   rewards(user_id, name, cost)
   retros(user_id, done, feel, next)
   meta(user_id, xp, level, coins, streak, last_clear)
========================= */
// meta í…Œì´ë¸” ì˜ˆì‹œ
// create table if not exists public.meta (
//   user_id uuid primary key references auth.users(id) on delete cascade,
//   xp int default 0, level int default 1, coins int default 0,
//   streak int default 0, last_clear date
// );
// alter table public.meta enable row level security;
// create policy "meta_self_select" on public.meta for select using (auth.uid() = user_id);
// create policy "meta_self_upsert" on public.meta for insert with check (auth.uid() = user_id);
// create policy "meta_self_update" on public.meta for update using (auth.uid() = user_id);

/* =========================
   2) í—¬í¼/ìƒíƒœ
========================= */
const todayKey = () => new Date().toISOString().slice(0,10);
const $ = (id) => document.getElementById(id);

const defaults = [
  { id:'coffee', name:'í•¸ë“œë“œë¦½ ì»¤í”¼ 1ì”', cost:80 },
  { id:'video',  name:'ì˜ìƒ 30ë¶„ ê°ìƒ',   cost:60 },
  { id:'walk',   name:'ì‚°ì±… 20ë¶„',       cost:40 },
  { id:'game',   name:'ê²Œì„ 30ë¶„',       cost:90 },
  { id:'book',   name:'ì±… êµ¬ì… 1ë§Œì›',   cost:500 },
  { id:'treat',  name:'ë§›ìˆëŠ” ê°„ì‹',     cost:120 }
];

const state = {
  user: null,
  profile: null,     // profiles.display_name
  meta: { xp:0, level:1, coins:0, streak:0, lastClear:null, selected:null, stats:{} },
  quests: [],        // ì˜¤ëŠ˜ ê²ƒë§Œ ë©”ëª¨ë¦¬ì— ë‘ 
  rewards: [],       // ë‚´ ë¦¬ì›Œë“œ
  retro: {}          // { [date]: {done, feel, next, ts} } â€” ì˜¤ëŠ˜ ì €ì¥ í›„ ë©”ëª¨ë¦¬ì—ë§Œ ë“¤ê³  ìˆìŒ
};

/* ê¸°ì¡´ ì—˜ë¦¬ë¨¼íŠ¸ ì°¸ì¡° (ì›ë³¸ ì½”ë“œì˜ ids ìœ ì§€) */
const els = {
  today: $('today'),
  list: $('list'),
  input: $('input'),
  add: $('add'),
  xp: $('xp'),
  level: $('level'),
  coins: $('coins'),
  xpbar: $('xpbar'),
  xpPct: $('xpPct'),
  dailybar: $('dailybar'),
  dailyPct: $('dailyPct'),
  log: $('log'),
  logbox: $('logbox'),
  streak: $('streak'),
  store: $('store'),
  modal: $('retroModal'),
  rDone: $('rDone'),
  rFeel: $('rFeel'),
  rNext: $('rNext'),
  rSave: $('rSave'),
  rCancel: $('rCancel'),
  rewardName: $('rewardName'),
  rewardCost: $('rewardCost'),
  rewardAdd: $('rewardAdd'),
  kebab: document.getElementById('kebab'),
  kebabBtn: $('kebabBtn'),
  kebabMenu: $('kebabMenu'),
  resetToday: $('resetToday'),
  resetAll: $('resetAll'),
  overlay: $('seasonOverlay'),
  retroToast: $('retroToast'),
  toastTitle: $('toastTitle'),
  tOpen: $('tOpen'),
  tLater: $('tLater'),
  buyToast: $('buyToast'),
  greet: document.getElementById('greet')
};

/* ì‚¬ìš´ë“œ/ì‘ì€ ìœ í‹¸ */
function blip(freq=880,ms=120){
  try{
    const ac=new (window.AudioContext||window.webkitAudioContext)();
    const o=ac.createOscillator(), g=ac.createGain();
    o.type='square'; o.frequency.value=freq; o.connect(g); g.connect(ac.destination);
    o.start(); g.gain.exponentialRampToValueAtTime(0.0001, ac.currentTime+ms/1000); setTimeout(()=>ac.close(),ms+80);
  }catch{}
}
function log(msg){
  const now = new Date();
  const line = `[${now.toTimeString().slice(0,5)}] ${msg}`;
  const prev = els.log.textContent === 'ì•„ì§ ê¸°ë¡ ì—†ìŒ' ? '' : els.log.textContent + ' ';
  els.log.textContent = prev + line;
  els.logbox.classList.add('flash'); setTimeout(()=>els.logbox.classList.remove('flash'),600);
}

/* =========================
   3) ì¸ì¦/í”„ë¡œí•„/ë©”íƒ€ ë¡œë“œ
========================= */
async function ensureAuthAndLoad(){
  // 3-1) ì¸ì¦ í™•ì¸
  const { data:{ user } } = await sb.auth.getUser();
  if(!user){ location.href = "login.html"; return; }
  state.user = user;

  // 3-2) í”„ë¡œí•„(ë‹‰ë„¤ì„)
  const { data: prof } = await sb.from('profiles').select('display_name').eq('id', user.id).maybeSingle();
  state.profile = prof || null;
  const name = state.profile?.display_name || user.email?.split('@')[0] || 'ì‚¬ìš©ì';
  if(els.greet) els.greet.textContent = `${name}ë‹˜ ì•ˆë…•í•˜ì„¸ìš” ì˜¤ëŠ˜ë„ ì¦ê±°ìš´ ë ˆë²¨ì—… ë˜ì„¸ìš” :)`;

  // 3-3) ë©”íƒ€ ë¡œë“œ(ì—†ìœ¼ë©´ ìƒì„±)
  let { data: meta } = await sb.from('meta').select('*').eq('user_id', user.id).maybeSingle();
  if(!meta){
    await sb.from('meta').insert({ user_id:user.id, xp:0, level:1, coins:0, streak:0, last_clear:null });
    meta = { xp:0, level:1, coins:0, streak:0, last_clear:null };
  }
  state.meta.xp = meta.xp||0; state.meta.level=meta.level||1; state.meta.coins=meta.coins||0;
  state.meta.streak = meta.streak||0; state.meta.lastClear = meta.last_clear;
  if(!state.meta.stats[todayKey()]) state.meta.stats[todayKey()] = { total:0, done:0 };

  // 3-4) ì˜¤ëŠ˜ í€˜ìŠ¤íŠ¸/ë¦¬ì›Œë“œ ë¡œë“œ
  await Promise.all([loadTodayQuests(), loadRewards()]);
  render();
}
async function saveMeta(){
  await sb.from('meta').upsert({
    user_id: state.user.id,
    xp: state.meta.xp,
    level: state.meta.level,
    coins: state.meta.coins,
    streak: state.meta.streak,
    last_clear: state.meta.lastClear
  });
}

/* =========================
   4) DB: í€˜ìŠ¤íŠ¸/ë¦¬ì›Œë“œ/íšŒê³  CRUD
========================= */
async function loadTodayQuests(){
  const { data, error } = await sb.from('quests')
    .select('*').eq('user_id', state.user.id).eq('date', todayKey())
    .order('created_at', { ascending:false });
  if(error){ console.error(error); return; }
  state.quests = data || [];
  state.meta.stats[todayKey()].total = state.quests.length;
  state.meta.stats[todayKey()].done = state.quests.filter(q=>q.done).length;
}

async function addQuestDB(text){
  const q = { user_id: state.user.id, text, date: todayKey(), doing:false, done:false, rewarded:false };
  const { data, error } = await sb.from('quests').insert(q).select().single();
  if(error){ console.error(error); return null; }
  return data;
}
async function updateQuestDB(id, patch){
  const { error } = await sb.from('quests').update(patch).eq('id', id);
  if(error) console.error(error);
}
async function deleteQuestDB(id){
  const { error } = await sb.from('quests').delete().eq('id', id);
  if(error) console.error(error);
}

async function loadRewards(){
  const { data, error } = await sb.from('rewards').select('*').eq('user_id', state.user.id).order('created_at', {ascending:false});
  if(error){ console.error(error); return; }
  state.rewards = (data && data.length) ? data : [];
  // ìµœì´ˆ ìœ ì €ë©´ ê¸°ë³¸ ë¦¬ì›Œë“œ ì±„ì›Œì£¼ê¸°
  if(!state.rewards.length){
    const rows = defaults.map(d=>({ user_id: state.user.id, name: d.name, cost: d.cost }));
    await sb.from('rewards').insert(rows);
    const { data:newRows } = await sb.from('rewards').select('*').eq('user_id', state.user.id).order('created_at',{ascending:false});
    state.rewards = newRows || [];
  }
}
async function addRewardDB(name, cost){
  const { data, error } = await sb.from('rewards').insert({ user_id:state.user.id, name, cost:Math.floor(cost) }).select().single();
  if(error){ console.error(error); return null; }
  return data;
}
async function updateRewardDB(id, patch){
  const { error } = await sb.from('rewards').update(patch).eq('id', id);
  if(error) console.error(error);
}
async function deleteRewardDB(id){
  const { error } = await sb.from('rewards').delete().eq('id', id);
  if(error) console.error(error);
}

async function insertRetro(done, feel, next){
  const { error } = await sb.from('retros').insert({ user_id:state.user.id, done, feel, next });
  if(error) console.error(error);
}

/* =========================
   5) ê¸°ì¡´ ë¡œì§ì„ Supabaseì— ë§ê²Œ ìˆ˜ì •
========================= */
function gainXP(n=10){
  const before = state.meta.xp % 100;
  state.meta.xp += n;
  state.meta.coins += n;
  if((state.meta.xp % 100) < before){ state.meta.level += 1; log(`Level Up! â†’ ${state.meta.level}`); blip(1200,150); }
  else blip(980,110);
  saveMeta();
}

function showRetroToast(message){
  els.toastTitle.textContent = message || 'ì™„ë£Œí–ˆìŠµë‹ˆë‹¤!';
  els.retroToast.classList.add('show');
}
function hideRetroToast(){ els.retroToast.classList.remove('show'); }

/* í€˜ìŠ¤íŠ¸ ì¶”ê°€/í‘œì‹œ/ì™„ë£Œ */
async function addQuest(text){
  const t = text.trim(); if(!t) return;
  const row = await addQuestDB(t);
  if(!row) return;
  state.quests.unshift(row);
  state.meta.stats[todayKey()].total++;
  state.meta.selected = row.id;
  log(`Added: ${t}`);
  render();
}
async function toggleDone(q){
  if(q.done){
    q.done = false;
    await updateQuestDB(q.id, { done:false, doing:false });
    log(`Reopened: ${q.text}`);
  }else{
    q.done = true; q.doing = false;
    let patch = { done:true, doing:false };
    if(!q.rewarded){
      q.rewarded = true;
      patch.rewarded = true;
      gainXP(10);
    }
    await updateQuestDB(q.id, patch);
    log(`Completed: ${q.text} (+10 XP once)`);
    showRetroToast(`â€˜${q.text}â€™ ì™„ë£Œ!`);
  }

  const today = todayKey();
  const todayItems = state.quests.filter(x=>x.date===today);
  state.meta.stats[today].done = todayItems.filter(x=>x.done).length;

  const allDone = todayItems.length>0 && todayItems.every(x=>x.done);
  if(allDone && state.meta.lastClear !== today){
    state.meta.streak += 1; state.meta.lastClear = today;
    log(`All quests cleared! Streak +1 â†’ ${state.meta.streak}`);
    saveMeta();
  }
  render();
}

/* ë¦¬ì›Œë“œ */
async function addReward(name, cost){
  const n = name.trim(); const c = Number(cost);
  if(!n || !Number.isFinite(c) || c<=0){ blip(250,160); return; }
  const row = await addRewardDB(n, c);
  if(!row) return;
  state.rewards.unshift(row);
  log(`Reward ì¶”ê°€: ${row.name} (${row.cost} ì½”ì¸)`); renderStore();
}
async function buyReward(r){
  if(state.meta.coins < r.cost){ log(`ì½”ì¸ì´ ë¶€ì¡±í•©ë‹ˆë‹¤ (${r.name})`); blip(220,160); return; }
  state.meta.coins -= r.cost; await saveMeta();
  log(`Reward ì‚¬ìš©: ${r.name} (-${r.cost} ì½”ì¸)`); blip(700,150);
  showBuyToast(); renderStats(); renderStore();
}
async function editReward(r){
  const n = prompt('ë¦¬ì›Œë“œ ì´ë¦„', r.name); if(n===null) return;
  const c = prompt('í•„ìš” ì½”ì¸', r.cost); if(c===null) return;
  const cost = Number(c); if(!n.trim() || !Number.isFinite(cost) || cost<=0){ blip(250,160); return; }
  await updateRewardDB(r.id, { name:n.trim(), cost:Math.floor(cost) });
  r.name = n.trim(); r.cost = Math.floor(cost);
  log(`Reward ìˆ˜ì •: ${r.name} (${r.cost} ì½”ì¸)`); renderStore();
}
async function deleteReward(id){
  await deleteRewardDB(id);
  state.rewards = state.rewards.filter(x=>x.id!==id);
  log('Reward ì‚­ì œ ì™„ë£Œ'); renderStore();
}

/* íšŒê³  ëª¨ë‹¬/ì €ì¥ */
function openRetro(){
  els.modal.classList.add('show');
  els.rDone.value=''; els.rFeel.value=''; els.rNext.value='';
  setTimeout(()=>els.rDone.focus(),10);
}
function closeRetro(){ els.modal.classList.remove('show'); }
els.rCancel.onclick = ()=> closeRetro();
els.rSave.onclick = async ()=>{
  const date = todayKey();
  const obj = { done:els.rDone.value.trim(), feel:els.rFeel.value.trim(), next:els.rNext.value.trim(), ts:Date.now() };
  state.retro[date] = obj;
  await insertRetro(obj.done, obj.feel, obj.next);
  log(`Retrospect saved for ${date}`);
  closeRetro();
};
els.tOpen.onclick  = ()=>{ hideRetroToast(); openRetro(); };
els.tLater.onclick = ()=> hideRetroToast();

/* kebab (ì  ë©”ë‰´) */
function toggleKebab(show){
  const willShow = typeof show==='boolean' ? show : !els.kebabMenu.classList.contains('show');
  els.kebabMenu.classList.toggle('show', willShow);
  els.kebabBtn.setAttribute('aria-expanded', willShow ? 'true' : 'false');
}
els.kebabBtn.addEventListener('click',(e)=>{ e.stopPropagation(); toggleKebab(); });
document.addEventListener('click',(e)=>{ if(!els.kebab.contains(e.target)) toggleKebab(false); });

/* ë¦¬ì…‹ */
async function resetToday(){
  if(!confirm('ì˜¤ëŠ˜ í€˜ìŠ¤íŠ¸ë¥¼ ëª¨ë‘ ì´ˆê¸°í™”í• ê¹Œìš”?')) return;
  const t = todayKey();
  // ì˜¤ëŠ˜ í€˜ìŠ¤íŠ¸ ì‚­ì œ
  await sb.from('quests').delete().eq('user_id', state.user.id).eq('date', t);
  // ì˜¤ëŠ˜ íšŒê³  ì‚­ì œ
  await sb.from('retros').delete().eq('user_id', state.user.id).gte('created_at', t).lt('created_at', t+'T23:59:59.999Z');

  state.quests = state.quests.filter(q=>q.date!==t);
  delete state.retro[t];
  state.meta.stats[t] = { total:0, done:0 };
  state.meta.selected = null;
  render(); log('ì˜¤ëŠ˜ ë°ì´í„° ì´ˆê¸°í™” ì™„ë£Œ');
  celebrateReset(false);
}
async function resetAll(){
  if(!confirm('ì •ë§ ëª¨ë“  ë°ì´í„°ë¥¼ ì™„ì „íˆ ì´ˆê¸°í™”í• ê¹Œìš”? (XP / LEVEL í¬í•¨)')) return;
  await Promise.all([
    sb.from('quests').delete().eq('user_id', state.user.id),
    sb.from('rewards').delete().eq('user_id', state.user.id),
    sb.from('retros').delete().eq('user_id', state.user.id),
    sb.from('meta').update({ xp:0, level:1, coins:0, streak:0, last_clear:null }).eq('user_id', state.user.id)
  ]);
  state.quests = [];
  state.rewards = [];
  state.meta = { xp:0, level:1, coins:0, streak:0, lastClear:null, selected:null, stats:{} };
  render();
  log('ì „ì²´ ì´ˆê¸°í™” ì™„ë£Œ â€” XP, ë ˆë²¨, ì½”ì¸, ìŠ¤íŠ¸ë¦­ ëª¨ë‘ ë¦¬ì…‹ë˜ì—ˆìŠµë‹ˆë‹¤.');
  blip(500,200);
  celebrateReset(true);
}

/* ì´ˆê¸°í™” ì¶•í•˜ ì—°ì¶œ (ì›ë³¸ ìœ ì§€) */
function celebrateReset(full=true){
  try{
    els.overlay.classList.remove('show'); void els.overlay.offsetWidth;
    els.overlay.querySelector('.msg').textContent = full ? 'ìƒˆ ì‹œì¦Œì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!' : 'ìƒˆë¡œìš´ í•˜ë£¨ê°€ ì‹œì‘ë˜ì—ˆë„¤ìš”! ì˜¤ëŠ˜ì˜ í€˜ìŠ¤íŠ¸ë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”!';
    els.overlay.classList.add('show');
    for(let i=0;i<22;i++){
      const p=document.createElement('div'); p.className='particle';
      const x=Math.random()*95+2; const delay=Math.random()*0.6;
      p.style.left = x+'vw'; p.style.top='-10px'; p.style.animationDelay=delay+'s';
      document.body.appendChild(p); setTimeout(()=>p.remove(), 2000);
    }
  }catch(e){}
}

/* ë Œë”ë§ (ì›ë³¸ êµ¬ì¡° ìœ ì§€) */
function render(){
  els.today.textContent = new Date().toLocaleDateString('ko-KR',{year:'numeric',month:'2-digit',day:'2-digit',weekday:'short'});
  renderQuests(); renderStats(); renderStore();
}
function renderQuests(){
  els.list.innerHTML = '';
  const today = todayKey();
  const todayItems = state.quests.filter(q => q.date === today);
  state.meta.stats[today] ||= { total:0, done:0 };
  state.meta.stats[today].total = todayItems.length;
  state.meta.stats[today].done  = todayItems.filter(q=>q.done).length;

  todayItems.forEach(q=>{
    const row = document.createElement('div');
    row.className = 'card' + (q.done ? ' done' : '') + (state.meta.selected===q.id ? ' flash' : '');
    row.tabIndex = 0;

    const badge = document.createElement('div'); badge.className='badge'; badge.textContent = q.done ? 'DONE' : (q.doing?'DOING':'TODO');
    const title = document.createElement('div'); title.className='title'; title.textContent=q.text;

    const actions = document.createElement('div'); actions.className='row';
    const bDo = mkBtn('ì§„í–‰','Doing',async()=>{ q.doing=true; q.done=false; await updateQuestDB(q.id,{doing:true,done:false}); log(`Started: ${q.text}`); render(); });
    const bDone = mkBtn('ì™„ë£Œ','Complete',()=>toggleDone(q));
    const bDel = mkBtn('ì‚­ì œ','Delete',async()=>{ await deleteQuestDB(q.id); state.quests = state.quests.filter(x=>x.id!==q.id); log(`Deleted: ${q.text}`); render(); });
    actions.append(bDo,bDone,bDel);

    row.onclick = ()=> state.meta.selected = q.id;
    row.append(badge,title,actions);
    els.list.append(row);
  });

  if(!todayItems.length) els.list.innerHTML = `<div class="small">ì˜¤ëŠ˜ í€˜ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. ìœ„ ì…ë ¥ì°½ì—ì„œ ì¶”ê°€í•˜ì„¸ìš”.</div>`;
}
function renderStats(){
  const xp100 = state.meta.xp % 100;
  els.xp.textContent = xp100;
  els.level.textContent = state.meta.level;
  els.coins.textContent = state.meta.coins;
  const xpPct = Math.min(100, Math.floor(xp100));
  els.xpbar.style.width = xpPct + '%';
  els.xpPct.textContent = xpPct + '%';

  const today = todayKey();
  const todayItems = state.quests.filter(q => q.date === today);
  const doneCount = todayItems.filter(q=>q.done).length;
  const dailyPct = todayItems.length ? Math.floor(doneCount / todayItems.length * 100) : 0;
  els.dailybar.style.width = dailyPct + '%';
  els.dailyPct.textContent = dailyPct + '%';
  els.streak.textContent = `Streak ${state.meta.streak} day`;
}
function renderStore(){
  els.store.innerHTML='';
  state.rewards.forEach(item=>{
    const wrap = document.createElement('div'); wrap.className='storeItem';
    wrap.innerHTML = `<div class="name">${item.name}</div><div class="cost">${item.cost} ì½”ì¸</div>`;
    const buy = document.createElement('button'); buy.className='buy'; buy.textContent='BUY';
    buy.onclick = ()=> buyReward(item);

    const row = document.createElement('div'); row.className='miniRow';
    const edit = document.createElement('button'); edit.className='mini'; edit.textContent='ìˆ˜ì •'; edit.onclick = ()=> editReward(item);
    const del = document.createElement('button'); del.className='mini'; del.textContent='ì‚­ì œ'; del.onclick = ()=> deleteReward(item.id);
    row.append(edit,del);

    wrap.append(buy,row);
    els.store.append(wrap);
  });
}
function mkBtn(txt, title, on){
  const d=document.createElement('div'); d.className='iconbtn'; d.textContent=txt; d.title=title; d.onclick=on; return d;
}

/* ì´ë²¤íŠ¸(ì›ë³¸ ìœ ì§€, DB ì—°ë™ìœ¼ë¡œ ì—°ê²°) */
els.add.onclick = async ()=>{ await addQuest(els.input.value); els.input.value=''; els.input.focus(); };
els.input.addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); els.add.click(); } });

els.rewardAdd.onclick = async ()=>{
  await addReward(els.rewardName.value, els.rewardCost.value);
  els.rewardName.value=''; els.rewardCost.value=''; els.rewardName.focus();
};

els.resetToday.onclick = resetToday;
els.resetAll.onclick = resetAll;

/* í† ìŠ¤íŠ¸/ë³´ìƒ */
function showBuyToast(){ els.buyToast.classList.add('show'); setTimeout(()=>els.buyToast.classList.remove('show'), 1600); }

/* ì´ˆê¸° ë‚ ì§œ/UI */
document.addEventListener('keydown',(e)=>{ if(e.key==='Escape' && els.modal.classList.contains('show')) els.rCancel.click(); });
els.today.textContent = new Date().toLocaleDateString('ko-KR',{year:'numeric',month:'2-digit',day:'2-digit',weekday:'short'});

/* ì‹œì‘: ì¸ì¦ í›„ ë°ì´í„° ë¡œë“œ */
ensureAuthAndLoad();
</script>


</body>
</html>
