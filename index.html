<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ToppingXP â€” ë§¤ì¼ì˜ ëª©í‘œë¥¼ ì‹œê°ì ìœ¼ë¡œ ê¸°ë¡í•˜ê³  ì„±ì¥í•˜ì„¸ìš”</title>

<!-- Supabase SDK -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<script>
  const SUPABASE_URL  = "https://mgpxqmqvlbjfywbbsiwt.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1ncHhxbXF2bGJqZnl3YmJzaXd0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3NDc3OTYsImV4cCI6MjA3ODMyMzc5Nn0.dMKOkI0Vsty6ZMOxJmfF4IAPmkKF4kPhRhjCLH0dxEk";
  window.sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
</script>

<style>
:root{
  --bg:#070c10; --g:#7aff7a; --g-deep:#1c7a1c;
  --glow:0 0 10px rgba(121,255,121,.5),0 0 18px rgba(121,255,121,.25);
  --btn-bg:#0a140a; --btn-bg-hover:#0f1d0f;
  --text-soft:#b6ffb6; --text-hover:#d4f77c;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; overflow:hidden;
  color:var(--g); font-family:ui-monospace, Menlo, Consolas, monospace;
  background: radial-gradient(1000px 700px at 50% 50%, #0b160b 0%, var(--bg) 70%);
}

/* ê²Œì„ ë°°ê²½ */
#gameWrap{position:fixed; inset:0; z-index:0;}
#game{display:block; width:100vw; height:100vh}

/* ìƒë‹¨ ì¹´í”¼ */
.hero{
  position:fixed; top:80px; left:50%; transform:translateX(-50%);
  z-index:10; text-align:center; max-width:min(800px,90%);
  pointer-events:none;
}
.hero h1{
  font-size:clamp(28px, 5vw, 48px); font-weight:900; margin:0 0 16px;
  text-shadow:var(--glow), 0 2px 8px rgba(0,0,0,0.8);
  line-height:1.2;
}
.hero p{
  font-size:clamp(14px, 2.5vw, 18px); color:#b6ffb6; margin:0 0 12px;
  text-shadow:0 1px 4px rgba(0,0,0,0.9);
  line-height:1.6;
}

/* ë²„íŠ¼ë“¤ */
.actions{
  position:fixed; bottom:80px; left:50%; transform:translateX(-50%);
  z-index:10; display:flex; gap:16px; flex-wrap:wrap; justify-content:center;
}
.btn{
  padding:14px 28px; border:2px solid var(--g); background:rgba(10,20,10,.9);
  color:var(--text-soft); font-weight:800; cursor:pointer;
  box-shadow:var(--glow); border-radius:10px; font-size:16px;
  font-family:inherit; transition:all 0.2s;
}
.btn:hover{background:var(--btn-bg-hover); color:var(--text-hover); transform:translateY(-2px)}

/* ìƒë‹¨ ìš°ì¸¡ ë©”ë‰´ */
.nav{
  position:fixed; top:20px; right:20px; z-index:15;
  display:flex; gap:12px; align-items:center;
}
.nav a, .nav button{
  padding:10px 18px; border:2px solid rgba(122,255,122,0.6);
  background:rgba(10,20,10,.85); color:var(--text-soft);
  text-decoration:none; font-weight:700; font-size:14px;
  border-radius:8px; cursor:pointer; font-family:inherit;
  transition:all 0.2s;
}
.nav a:hover, .nav button:hover{
  background:rgba(15,29,15,.95); color:var(--text-hover);
  border-color:var(--g);
}

/* í‚¤ ë„ì›€ë§(ì¢Œí•˜ë‹¨) */
.hint{
  position:fixed; left:14px; bottom:12px; z-index:9;
  font-size:12px; color:#a7ffa7; opacity:.85;
  background:rgba(0,0,0,.25); padding:6px 8px;
  border:1px solid rgba(28,122,28,.35); border-radius:6px;
}

/* ì˜¤ë¸Œì íŠ¸ HP ë°” - í”½ì…€ì•„íŠ¸ ë ˆíŠ¸ë¡œ ìŠ¤íƒ€ì¼ */
.hp-bar-wrap{
  position:fixed; top:200px; left:50%; transform:translateX(-50%);
  z-index:12; width:min(420px,85%); text-align:center;
}
.hp-bar-wrap .label{
  font-size:14px; font-weight:800; margin-bottom:8px;
  text-shadow:var(--glow);
  font-family: 'Courier New', monospace;
  letter-spacing: 2px;
}
.hp-bar{
  width:100%; height:32px;
  background:#000;
  border:4px solid #7aff7a;
  box-shadow:inset 0 0 0 2px #000, 0 4px 0 #1c7a1c;
  position:relative;
  image-rendering: pixelated;
  image-rendering: crisp-edges;
}
.hp-fill{
  position:absolute; left:0; top:0; bottom:0;
  background:repeating-linear-gradient(
    90deg,
    #ff3333 0px,
    #ff3333 4px,
    #ff5555 4px,
    #ff5555 8px
  );
  transition:width 0.2s steps(10);
  box-shadow:inset 0 -4px 0 rgba(0,0,0,0.3);
  image-rendering: pixelated;
}
.hp-text{
  position:absolute; inset:0; display:flex; align-items:center;
  justify-content:center; font-size:14px; font-weight:800;
  color:#fff; text-shadow:2px 2px 0 #000;
  font-family: 'Courier New', monospace;
  letter-spacing: 1px;
}

/* í­ë°œ ì˜¤ë²„ë ˆì´ */
#explosion{
  position:fixed; inset:0; display:none; align-items:center;
  justify-content:center; background:rgba(255,100,0,0.3);
  z-index:20; pointer-events:none;
}
#explosion.show{display:flex; animation:explode 0.8s ease}
@keyframes explode{
  0%{opacity:0; transform:scale(0.5)}
  50%{opacity:1; transform:scale(1.2)}
  100%{opacity:0; transform:scale(1)}
}
#explosion .msg{
  font-size:48px; font-weight:900; color:#fff;
  text-shadow:0 0 20px rgba(255,100,0,0.8);
}

@media(max-width:600px){
  .hero h1{font-size:24px}
  .hero p{font-size:13px}
  .actions{bottom:60px; gap:10px}
  .btn{padding:12px 20px; font-size:14px}
}
</style>
</head>
<body>
<div id="gameWrap"><canvas id="game"></canvas></div>

<!-- ìƒë‹¨ ì¹´í”¼ -->
<div class="hero">
  <h1>ë§¤ì¼ì˜ ëª©í‘œë¥¼ ì‹œê°ì ìœ¼ë¡œ ê¸°ë¡í•˜ê³  ì„±ì¥í•˜ì„¸ìš”.</h1>
  <p>í•˜ë£¨ì˜ ë£¨í‹´ê³¼ ì„±ì·¨ë¥¼ í•œëˆˆì— ê´€ë¦¬í•  ìˆ˜ ìˆëŠ” ìƒì‚°ì„± ì•±.<br>
  ì›¹ê³¼ Windows ì–´ë””ì„œë“  ì´ì–´ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
</div>

<!-- HP ë°” -->
<div class="hp-bar-wrap" id="hpWrap" style="display:none">
  <div class="label">ğŸ¯ íƒ€ê²Ÿì„ íŒŒê´´í•˜ì„¸ìš”!</div>
  <div class="hp-bar">
    <div class="hp-fill" id="hpFill"></div>
    <div class="hp-text" id="hpText">100 / 100</div>
  </div>
</div>

<!-- í­ë°œ -->
<div id="explosion"><div class="msg">ğŸ’¥ DESTROYED!</div></div>

<!-- ìƒë‹¨ ìš°ì¸¡ ë©”ë‰´ -->
<div class="nav">
  <a href="download.html">Download</a>
  <button id="musicBtn">ğŸµ</button>
</div>

<!-- í•˜ë‹¨ ì•¡ì…˜ ë²„íŠ¼ -->
<div class="actions">
  <button class="btn" id="startBtn">ë°”ë¡œ ì‹œì‘í•˜ê¸°</button>
</div>

<div class="hint">â†/â†’ ì´ë™ Â· â†‘ ë“± ë³´ì´ê¸° Â· â†“ ì •ë©´ ë³´ê¸° Â· Space ë°œì‚¬</div>

<!-- ë°°ê²½ ìŒì•… -->
<audio id="bgm" src="https://mgpxqmqvlbjfywbbsiwt.supabase.co/storage/v1/object/public/music/toppingxp.mp3" loop></audio>

<script>
/* ===== ë°°ê²½ ìŒì•… í† ê¸€ ===== */
const music = document.getElementById('bgm');
const musicBtn = document.getElementById('musicBtn');
let playing = false;
musicBtn.onclick = ()=>{
  if(!playing){ music.play(); musicBtn.textContent="â¸"; playing=true; }
  else{ music.pause(); musicBtn.textContent="ğŸµ"; playing=false; }
};
</script>

<script>
/* ===== ë²„íŠ¼ ë¡œì§ ===== */
const startBtn = document.getElementById('startBtn');
const hpWrap = document.getElementById('hpWrap');

// ì´ë¯¸ ë¡œê·¸ì¸ë˜ì–´ ìˆìœ¼ë©´ ì•±ìœ¼ë¡œ
(async function guard(){
  const {data:{user}}=await sb.auth.getUser();
  if(user) location.href="app.html";
})();

startBtn.onclick = () => location.href="login.html";

// í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ìœ¼ë¡œ ê²Œì„ ì‹œì‘
setTimeout(() => {
  hpWrap.style.display = 'block';
  gameActive = true;
  spawnTarget();
}, 500);
</script>

<script>
/* ========== ë°°ê²½/ìºë¦­í„° ë¯¸ë‹ˆê²Œì„ ========== */

const BG_URL = "images/background_landing.png";

const SPRITES = {
  stopRight: "https://mgpxqmqvlbjfywbbsiwt.supabase.co/storage/v1/object/public/images/stop-right.png",
  right:     "https://mgpxqmqvlbjfywbbsiwt.supabase.co/storage/v1/object/public/images/right.png",
  center:    "https://mgpxqmqvlbjfywbbsiwt.supabase.co/storage/v1/object/public/images/center.png",
  back:      "https://mgpxqmqvlbjfywbbsiwt.supabase.co/storage/v1/object/public/images/back.png",
  attack:    "https://mgpxqmqvlbjfywbbsiwt.supabase.co/storage/v1/object/public/images/attack.png",
  fireSmall: "https://mgpxqmqvlbjfywbbsiwt.supabase.co/storage/v1/object/public/images/small-fire.png",
  fireBig:   "https://mgpxqmqvlbjfywbbsiwt.supabase.co/storage/v1/object/public/images/fire.png"
};
const EVERY_N_BIG = 3;

const canvas=document.getElementById('game'), ctx=canvas.getContext('2d',{alpha:false});
let W=innerWidth,H=innerHeight; canvas.width=W; canvas.height=H;
addEventListener('resize',()=>{W=innerWidth;H=innerHeight;canvas.width=W;canvas.height=H; rebuildTile();});
ctx.imageSmoothingEnabled=false;

const BG = new Image(); BG.decoding="async"; BG.src=BG_URL;
const BOX_IMG = new Image(); BOX_IMG.decoding="async"; BOX_IMG.src="images/box.png";
function loadImage(url){const img=new Image(); img.decoding="async"; img.src=url; return img;}
const IMGS={
  stopRight: loadImage(SPRITES.stopRight),
  right:     loadImage(SPRITES.right),
  center:    loadImage(SPRITES.center),
  back:      loadImage(SPRITES.back),
  attack:    loadImage(SPRITES.attack),
  fireSmall: loadImage(SPRITES.fireSmall),
  fireBig:   loadImage(SPRITES.fireBig)
};

let bgScale=1, floorY=H-60, camX=0;
let tileCan=null, tileCtx=null, tileW=0, tileH=0, bgPattern=null;

function placeOnFloor(){ player.y = floorY - player.h; }

function rebuildTile(){
  if(!BG.complete) return;
  bgScale = H / BG.naturalHeight;
  tileW = Math.ceil(BG.naturalWidth * bgScale);
  tileH = Math.ceil(BG.naturalHeight * bgScale);
  tileCan = document.createElement('canvas');
  tileCan.width  = tileW + 2;
  tileCan.height = tileH;
  tileCtx = tileCan.getContext('2d',{alpha:false});
  tileCtx.imageSmoothingEnabled=false;
  tileCtx.drawImage(BG, 0, 0, tileW + 1, tileH);
  bgPattern = ctx.createPattern(tileCan,'repeat-x');
  const groundStrip = Math.round(tileH * 0.14);
  floorY = H - groundStrip - 4;
  placeOnFloor();
}
BG.onload = () => rebuildTile();

function drawBGPattern(g){
  if(!bgPattern) return;
  g.save();
  g.setTransform(1,0,0,1,0,0);
  g.imageSmoothingEnabled=false;
  const raw = camX * bgScale;
  const off = ((raw % tileW) + tileW) % tileW;
  g.translate(-Math.round(off), 0);
  g.fillStyle = bgPattern;
  g.fillRect(-tileW - 4, 0, W + tileW*3 + 8, H);
  g.restore();
}

const player={
  x: W*0.52, y: H-128, w: 96, h: 96,
  vx:0, speed: 170,
  dir: 1,
  attacking:0,
  pose: "side",
  animIndex:0, animTimer:0
};
placeOnFloor();

const keys={left:false,right:false, space:false};
addEventListener('keydown',e=>{
  const tag = document.activeElement.tagName;
  const typing = tag==='INPUT' || tag==='TEXTAREA';

  if(e.key===' '){
    if(!typing){ e.preventDefault(); keys.space=true; }
  }
  if(['ArrowLeft','a','A'].includes(e.key) && !typing) keys.left=true;
  if(['ArrowRight','d','D'].includes(e.key) && !typing) keys.right=true;

  if(e.key==='ArrowUp' && !typing){
    player.pose='back'; player.attacking=0;
  }
  if(e.key==='ArrowDown' && !typing){
    player.pose='front'; player.attacking=0;
  }
});
addEventListener('keyup',e=>{
  if(e.key===' ') keys.space=false;
  if(['ArrowLeft','a','A'].includes(e.key)) keys.left=false;
  if(['ArrowRight','d','D'].includes(e.key)) keys.right=false;

  if(e.key==='ArrowUp' || e.key==='ArrowDown'){
    player.pose='side';
  }
});

/* íˆ¬ì‚¬ì²´ */
const shots=[]; let shotCount=0, lastShot=0;
function shoot(){
  const now=performance.now();
  if(now-lastShot<180) return;
  lastShot=now; shotCount++;

  const big = EVERY_N_BIG>0 && (shotCount % EVERY_N_BIG===0);
  const img = big && IMGS.fireBig.complete ? IMGS.fireBig : IMGS.fireSmall;
  const size = big ? 54 : 32;
  const speed = big ? 530 : 430;
  const damage = big ? 15 : 10;

  const startX = player.dir===1 ? (player.x + player.w - 20) : (player.x + 20 - size);
  shots.push({
    x:startX, y: player.y + player.h*0.58 - size*0.5,
    vx: player.dir===1 ? speed : -speed,
    w:size, h:size, img, life: 2200, damage
  });

  player.attacking = 140;
}

/* íƒ€ê²Ÿ ì˜¤ë¸Œì íŠ¸ */
let target = null;
let gameActive = false;

function spawnTarget(){
  const size = 120;
  target = {
    x: W*0.5 - size*0.5,
    y: floorY - size - 10,
    w: size,
    h: size,
    hp: 100,
    maxHp: 100,
    shakeX: 0,
    shakeY: 0,
    shakeTime: 0
  };
  updateHPBar();
}

function shakeTarget(){
  if(!target) return;
  target.shakeTime = 200; // 200ms í”ë“¤ë¦¼
}

function updateHPBar(){
  if(!target) return;
  const pct = Math.max(0, (target.hp / target.maxHp) * 100);
  document.getElementById('hpFill').style.width = pct + '%';
  document.getElementById('hpText').textContent = Math.max(0, target.hp) + ' / ' + target.maxHp;
}

function checkCollision(shot, obj){
  return shot.x < obj.x + obj.w &&
         shot.x + shot.w > obj.x &&
         shot.y < obj.y + obj.h &&
         shot.y + shot.h > obj.y;
}

function destroyTarget(){
  target = null;
  gameActive = false;

  // í­ë°œ íš¨ê³¼
  const exp = document.getElementById('explosion');
  exp.classList.add('show');

  setTimeout(() => {
    exp.classList.remove('show');
    location.href = 'login.html';
  }, 1200);
}

/* ì—…ë°ì´íŠ¸ */
let last=0;
function update(dt){
  if(keys.left){ player.vx=-player.speed; player.dir=-1; camX-=player.speed*0.25*dt; }
  else if(keys.right){ player.vx= player.speed; player.dir= 1; camX+=player.speed*0.25*dt; }
  else { player.vx*=0.85; if(Math.abs(player.vx)<0.5) player.vx=0; }

  if(player.pose==='side' && Math.abs(player.vx)>1){
    player.animTimer += dt*1000;
    if(player.animTimer>120){ player.animTimer=0; player.animIndex = 1 - player.animIndex; }
  }else{
    player.animIndex = 0;
  }

  if(keys.space && player.pose==='side') shoot();

  player.x += player.vx*dt;
  const minX=20, maxX=W-20-player.w;
  if(player.x<minX) player.x=minX;
  if(player.x>maxX) player.x=maxX;
  if(player.attacking>0) player.attacking -= dt*1000;

  // íƒ€ê²Ÿ í”ë“¤ë¦¼ ì—…ë°ì´íŠ¸
  if(target && target.shakeTime > 0){
    target.shakeTime -= dt*1000;
    const intensity = 5;
    target.shakeX = (Math.random() - 0.5) * intensity;
    target.shakeY = (Math.random() - 0.5) * intensity;
    if(target.shakeTime <= 0){
      target.shakeX = 0;
      target.shakeY = 0;
    }
  }

  // íˆ¬ì‚¬ì²´ ì—…ë°ì´íŠ¸ & ì¶©ëŒ ê°ì§€
  for(let i=shots.length-1;i>=0;i--){
    const s=shots[i];
    s.x += s.vx*dt;
    s.life -= dt*1000;

    // íƒ€ê²Ÿê³¼ ì¶©ëŒ ì²´í¬
    if(gameActive && target && checkCollision(s, target)){
      target.hp -= s.damage;
      updateHPBar();
      shakeTarget(); // í”ë“¤ë¦¼ íš¨ê³¼
      shots.splice(i,1);

      if(target.hp <= 0){
        destroyTarget();
      }
      continue;
    }

    if(s.x<-s.w || s.x>W+s.w || s.life<=0) shots.splice(i,1);
  }
}

/* ê·¸ë¦¬ê¸° */
function draw(){
  drawBGPattern(ctx);

  // íƒ€ê²Ÿ ê·¸ë¦¬ê¸°
  if(target && gameActive){
    const tx=Math.round(target.x + target.shakeX);
    const ty=Math.round(target.y + target.shakeY);

    // ë°•ìŠ¤ ê·¸ë¦¼ì
    ctx.fillStyle = 'rgba(0,0,0,0.3)';
    ctx.fillRect(tx+4, ty+4, target.w, target.h);

    // ë°•ìŠ¤ ì´ë¯¸ì§€ ê·¸ë¦¬ê¸°
    if(BOX_IMG.complete){
      ctx.imageSmoothingEnabled = false;
      ctx.drawImage(BOX_IMG, tx, ty, target.w, target.h);
    } else {
      // ì´ë¯¸ì§€ ë¡œë“œ ì „ í´ë°±
      ctx.fillStyle = '#8B4513';
      ctx.fillRect(tx, ty, target.w, target.h);
      ctx.strokeStyle = '#654321';
      ctx.lineWidth = 3;
      ctx.strokeRect(tx, ty, target.w, target.h);
    }

    // HP í…ìŠ¤íŠ¸ (í”½ì…€ ì•„íŠ¸ ìŠ¤íƒ€ì¼)
    ctx.fillStyle = '#000';
    ctx.font = 'bold 16px "Courier New", monospace';
    ctx.textAlign = 'center';
    ctx.fillText(Math.max(0, target.hp) + ' HP', tx + target.w/2 + 2, ty + target.h/2 + 8);
    ctx.fillStyle = '#fff';
    ctx.fillText(Math.max(0, target.hp) + ' HP', tx + target.w/2, ty + target.h/2 + 6);
  }

  // íˆ¬ì‚¬ì²´
  for(const s of shots){
    const dx=Math.round(s.x), dy=Math.round(s.y);
    if(s.img && s.img.complete){
      if(s.vx>=0) ctx.drawImage(s.img, dx, dy, s.w, s.h);
      else{
        ctx.save(); ctx.translate(dx+s.w,0); ctx.scale(-1,1);
        ctx.drawImage(s.img, 0, dy, s.w, s.h); ctx.restore();
      }
    }else{ ctx.fillStyle="#ff9a00"; ctx.fillRect(dx,dy,s.w,s.h); }
  }

  // í”Œë ˆì´ì–´
  const px=Math.round(player.x), py=Math.round(player.y);
  let img = null;
  if(player.pose==='front' && IMGS.center.complete) img = IMGS.center;
  else if(player.pose==='back' && IMGS.back.complete) img = IMGS.back;
  else{
    if(player.attacking>0 && IMGS.attack.complete) img = IMGS.attack;
    else{
      img = (Math.abs(player.vx)>1 && player.animIndex===0) ? IMGS.right : IMGS.stopRight;
    }
  }

  if(player.dir===1){
    if(img && img.complete) ctx.drawImage(img, px, py, player.w, player.h);
  }else{
    ctx.save(); ctx.translate(px+player.w,0); ctx.scale(-1,1);
    if(img && img.complete) ctx.drawImage(img, 0, py, player.w, player.h);
    ctx.restore();
  }
}

/* ë£¨í”„ */
function loop(ts){
  const dt=Math.min(0.033,(ts-last)/1000||0.016); last=ts;
  update(dt); draw();
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
</script>

</body>
</html>
