<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ToppingXP â€” Quests</title>


  <!-- â‘  SDK: í•œ ë²ˆë§Œ ë¡œë“œ -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <!-- â‘¡ í´ë¼ì´ì–¸íŠ¸ ì¦‰ì‹œ ìƒì„±: ë©”ì¸ ìŠ¤í¬ë¦½íŠ¸ë³´ë‹¤ ë¨¼ì € -->
  <script>
    const SUPABASE_URL  = "https://mgpxqmqvlbjfywbbsiwt.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1ncHhxbXF2bGJqZnl3YmJzaXd0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3NDc3OTYsImV4cCI6MjA3ODMyMzc5Nn0.dMKOkI0Vsty6ZMOxJmfF4IAPmkKF4kPhRhjCLH0dxEk";
    window.sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
    console.log("[supabase] client ready:", !!window.sb);
  </script>
  <style>

        <!-- â‘¡ ëª¨ë°”ì¼ ê°€ë¡œê¸¸ì´ ì œí•œ -->
      @media (max-width: 980px){
        .app{ grid-template-columns: 1fr; }
        .panel{ padding:16px 12px; }
        .statGrid{ grid-template-columns: 1fr; }
        .storeGrid{ grid-template-columns: 1fr 1fr; }
        .storeTop{ grid-template-columns: 1fr 1fr; }
      }
      @media (max-width: 420px){
        body{ font-size:15px; }
        .h1{ font-size:18px; }
        .panel{ padding:14px 10px; }
        .card{ grid-template-columns: 1fr; gap:8px; }
        .storeGrid{ grid-template-columns: 1fr; }
        .storeTop{ grid-template-columns: 1fr; gap:8px; }
        .kebabMenu{ max-width:92vw; right:0; }
      }


    :root{
      --bg:#0a0f0a; --grid:#142714; --g:#79ff79; --g-weak:#36c436; --g-deep:#1c7a1c;
      --scan:rgba(121,255,121,.06);
      --glow:0 0 10px rgba(121,255,121,.5),0 0 18px rgba(121,255,121,.25);
      --btn-bg:#0a140a; --btn-bg-hover:#0f1d0f;
      --text-soft:#b6ffb6; --text-hover:#d4f77c;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:radial-gradient(1100px 700px at 50% 50%, #0b160b 0%, var(--bg) 60%);
      color:var(--g); font-family: ui-monospace, Menlo, Consolas, monospace; letter-spacing:.2px; font-size:16px;
    }
    .app{position:relative; height:100%; display:grid; grid-template-columns: 1.15fr .85fr; gap:2px}
    .panel{
      position:relative; padding:18px 16px;
      background:
        linear-gradient(0deg, transparent 23px, var(--grid) 24px),
        linear-gradient(90deg, transparent 23px, var(--grid) 24px);
      background-size:24px 24px;
      border:1px solid var(--g-deep);
      box-shadow:inset 0 0 0 2px rgba(28,122,28,.2);
    }
    .app.crt::after{
      content:""; position:absolute; inset:0;
      background:repeating-linear-gradient(0deg,var(--scan) 0 2px, transparent 2px 4px);
      mix-blend-mode:screen; pointer-events:none;
      animation:scan 6s linear infinite, flicker 2.8s steps(60) infinite;
    }
    @keyframes scan{0%{opacity:.25}50%{opacity:.18}100%{opacity:.25}}
    @keyframes flicker{50%{filter:brightness(1.04)}}

    .h1{font-size:20px; margin:0 0 2px; text-shadow:var(--glow); font-weight:800}
    .sub{color:var(--g-weak); margin:0 0 12px; font-size:14px}
    .date{font-size:12px; color:#a6ffa6; margin-bottom:10px}

    .inputRow{display:flex; gap:10px; margin:10px 0 12px}
    .input{
      flex:1; padding:12px 12px; border:2px solid var(--g-deep); background:#0a130a; color:var(--g);
      box-shadow:inset 0 0 0 2px rgba(28,122,28,.18); font-size:15px
    }
    .btn{
      padding:12px 14px; border:2px solid var(--g); background:var(--btn-bg); color:var(--text-soft);
      font-weight:800; cursor:pointer; box-shadow:var(--glow); line-height:1; min-width:68px; text-align:center
    }
    .btn:hover,.btn:focus{background:var(--btn-bg-hover); color:var(--text-hover); outline:none}

    .list{display:flex; flex-direction:column; gap:10px; min-height:140px}
    .card{
      border:2px solid var(--g-deep); background:rgba(0,0,0,.08); padding:10px 12px;
      display:grid; grid-template-columns:auto 1fr auto; gap:10px; align-items:center;
      box-shadow:inset 0 0 0 2px rgba(28,122,28,.15);
    }
    .badge{font-size:12px; padding:3px 8px; border:2px solid var(--g-deep)}
    .title{overflow:hidden; text-overflow:ellipsis; white-space:nowrap; font-size:15px}
    .row{display:flex; gap:8px; align-items:center}
    .iconbtn{
      border:2px solid var(--g-deep); padding:7px 9px; cursor:pointer; background:#0b130b; color:var(--text-soft);
      transition:transform .02s, background .15s
    }
    .iconbtn:hover{background:#122012}
    .iconbtn:active{transform:translateY(1px)}
    .done .title{text-decoration:line-through; opacity:.75}
    .done{border-color:var(--g)}

    .rightGrid{display:grid; grid-template-rows:auto auto 1fr auto; gap:14px; height:100%}
    .box{
      border:2px solid var(--g-deep); padding:12px; box-shadow:inset 0 0 0 2px rgba(29,122,29,.18);
    }
    .statTop{display:flex; justify-content:space-between; gap:10px; align-items:center; margin-bottom:8px}
    .kebab{position:relative; z-index:5000}
    .kebabBtn{
      border:2px solid var(--g-deep); background:#0b130b; color:var(--text-soft);
      padding:8px 10px; cursor:pointer; font-weight:800;
    }
    .kebabBtn:hover{background:#122012}
    .kebabMenu{
      position:absolute; right:0; top:40px; min-width:190px; display:none;
      background:#0a130a; border:2px solid var(--g-deep); box-shadow:var(--glow); z-index:6000;
    }
    .kebabMenu.show{display:block}
    .kebabMenu button{
      width:100%; text-align:left; padding:10px 12px; background:transparent; border:0; color:var(--text-soft); cursor:pointer;
    }
    .kebabMenu button:hover{background:#122012; color:var(--text-hover)}

    .small{font-size:12px; color:var(--g-weak)}
    .statGrid{display:grid; grid-template-columns:repeat(3,1fr); gap:10px}
    .slab{display:grid; place-items:center; min-height:62px; font-weight:800; font-size:15px}

    .bars{display:grid; gap:10px}
    .bar{position:relative; border:2px solid var(--g-deep); height:26px; box-shadow:inset 0 0 0 2px rgba(29,122,29,.18)}
    .bar>span{position:absolute; inset:0 auto 0 0; width:0; background:linear-gradient(90deg, rgba(121,255,121,.55), rgba(121,255,121,.9))}
    .barlabel{position:absolute; inset:0; display:flex; justify-content:space-between; align-items:center; padding:0 10px; font-weight:800}

    .storeTop{display:grid; grid-template-columns:1fr auto auto; gap:10px; align-items:center; margin-bottom:8px}
    .storeTop .input{padding:10px}
    .storeGrid{display:grid; grid-template-columns:repeat(3,1fr); gap:10px}
    .storeItem{border:2px solid var(--g-deep); padding:10px; display:grid; gap:10px; text-align:center;
      box-shadow:inset 0 0 0 2px rgba(29,122,29,.18)}
    .storeItem .name{font-weight:800}
    .storeItem .cost{font-weight:800}
    .miniRow{display:flex; gap:6px; justify-content:center}
    .mini{border:2px solid var(--g-deep); background:#0b130b; color:var(--text-soft); padding:6px 8px; cursor:pointer; font-size:12px}
    .mini:hover{background:#122012}
    .storeItem .buy{border:2px solid var(--g); padding:8px 10px; cursor:pointer; background:var(--btn-bg); color:var(--text-soft); font-weight:800}
    .storeItem .buy:hover{background:var(--btn-bg-hover); color:var(--text-hover)}

    .flash{animation:flash .6s ease}
    @keyframes flash{0%{box-shadow:0 0 0 0 rgba(121,255,121,0)}60%{box-shadow:0 0 18px 6px rgba(121,255,121,.35)}100%{box-shadow:0 0 0 0 rgba(121,255,121,0)}}

    /* íšŒê³  ëª¨ë‹¬ */
    .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.45)}
    .modal.show{display:flex}
    .modalCard{width:min(520px,92%); background:#091109; color:var(--g); border:2px solid var(--g-deep); box-shadow:var(--glow); padding:16px; display:grid; gap:12px}
    .modalCard textarea,.modalCard input{width:100%; padding:10px; border:2px solid var(--g-deep); background:rgba(0,0,0,.15); color:var(--g)}
    .modalBtns{display:flex; gap:8px; justify-content:flex-end}

    /* ì˜¤ë¥¸ìª½ í•˜ë‹¨ í† ìŠ¤íŠ¸ */
    .toast{
      position:fixed; right:22px; bottom:22px; z-index:7000;
      display:none; min-width:320px;
      background:#091109; color:var(--g);
      border:2px solid var(--g-deep); box-shadow:var(--glow);
      padding:14px 16px;
    }
    .toast.show{ display:block; animation:toastIn .18s ease }
    .toast .tmsg{ font-weight:800; margin-bottom:6px }
    .toast .tdesc{ font-size:13px; color:var(--text-soft); margin-bottom:10px }
    .toast .tbtns{ display:flex; gap:8px; justify-content:flex-end }
    @keyframes toastIn{ from{ transform:translateY(6px); opacity:0 } to{ transform:translateY(0); opacity:1 } }

    /* ì´ˆê¸°í™” ì¶•í•˜ ì˜¤ë²„ë ˆì´ */
    #seasonOverlay{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background:radial-gradient(ellipse at center, rgba(160,255,160,.15), rgba(0,0,0,.7) 70%);
      z-index:9999; pointer-events:none;
    }
    #seasonOverlay.show{display:flex; animation:fadeOut 1.8s ease forwards 1.2s}
    #seasonOverlay .msg{
      color:#d6ffd6; font-size:28px; font-weight:900; letter-spacing:.6px; text-shadow:var(--glow);
      animation:punch .6s ease;
    }
    @keyframes punch{0%{transform:scale(.7); opacity:.0}60%{transform:scale(1.1); opacity:1}100%{transform:scale(1)}}
    @keyframes fadeOut{to{opacity:0}}

    /* íŒŒí‹°í´ */
    .particle{
      position:fixed; width:6px; height:6px; border:2px solid #9bff9b; border-radius:50%;
      box-shadow:0 0 8px rgba(155,255,155,.7); z-index:9999; pointer-events:none;
      animation:fall 1.6s ease-in forwards;
    }
    @keyframes fall{0%{transform:translateY(-20px) scale(1); opacity:1}100%{transform:translateY(90vh) scale(.7); opacity:0}}

    @media(max-width:980px){
      .app{grid-template-columns:1fr}
      .storeGrid{grid-template-columns:1fr 1fr}
    }
  </style>
</head>
<body>
<div class="app crt" id="app">
  <div id="seasonOverlay"><div class="msg">ìƒˆ ì‹œì¦Œì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!</div></div>

  <!-- LEFT -->
  <section class="panel">
    <div class="h1">Quests</div>
    <div class="date" id="today"></div>
    <div class="sub" id="greet"></div>

    <p class="sub">í•œ ì¤„ í€˜ìŠ¤íŠ¸ ì…ë ¥ í›„ <b>Enter</b> ë˜ëŠ” <b>ì¶”ê°€</b> ë²„íŠ¼ìœ¼ë¡œ ë“±ë¡. ì™„ë£Œí•  ë•Œë§ˆë‹¤ ì˜¤ë¥¸ìª½ì— ì•ˆë‚´ê°€ ëœ¹ë‹ˆë‹¤.</p>

    <div class="inputRow">
      <input id="input" class="input" placeholder="ì˜ˆ) ê³ ê° ì¸í„°ë·° ì¼ì • í™•ì • ë©”ì¼ ë³´ë‚´ê¸°" />
      <button id="add" class="btn">ì¶”ê°€</button>
    </div>

    <div id="list" class="list" aria-live="polite"></div>
  </section>

  <!-- RIGHT -->
  <section class="panel">
    <div class="h1">Status</div>

    <div class="rightGrid">
      <div class="box">
        <div class="statTop">
          <div class="small">ì§„í–‰ í˜„í™©</div>
          <div class="kebab" id="kebab">
            <button class="kebabBtn" id="kebabBtn" aria-haspopup="true" aria-expanded="false">â‹¯</button>
            <div class="kebabMenu" id="kebabMenu" role="menu">
              <button id="giveUpToday" role="menuitem">í€˜ìŠ¤íŠ¸ ì´ˆê¸°í™”</button>
              <button id="resetLevel"  role="menuitem">ë ˆë²¨ ì´ˆê¸°í™”</button>
              <button id="logout"      role="menuitem">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
          </div>
        </div>
        <div class="statGrid">
          <div class="slab"><div>LEVEL&nbsp;<span id="level">1</span></div></div>
          <div class="slab"><div>XP&nbsp;<span id="xp">0</span>/100</div></div>
          <div class="slab"><div>COINS&nbsp;<span id="coins">0</span></div></div>
        </div>
      </div>

      <div class="box">
        <div class="bars">
          <div class="bar"><span id="xpbar"></span><div class="barlabel"><span>XP</span><span id="xpPct">0%</span></div></div>
          <div class="bar"><span id="dailybar"></span><div class="barlabel"><span>DAILY</span><span id="dailyPct">0%</span></div></div>
        </div>
        <div class="small" id="streak" style="margin-top:6px">Streak 0 day</div>
      </div>

      <div class="box" id="logbox">
        <div class="h1" style="font-size:18px">Activity Log</div>
        <div class="small" id="log">ì•„ì§ ê¸°ë¡ ì—†ìŒ</div>
      </div>

      <div class="box">
        <div class="h1" style="font-size:18px">Reward Store</div>
        <div class="storeTop">
          <input id="rewardName" class="input" placeholder="ë¦¬ì›Œë“œ ì´ë¦„ (ì˜ˆ: ì‚°ì±… 20ë¶„)" />
          <input id="rewardCost" class="input" inputmode="numeric" placeholder="ì½”ì¸" style="max-width:120px" />
          <button id="rewardAdd" class="btn">ì¶”ê°€</button>
        </div>
        <div class="storeGrid" id="store"></div>
      </div>
    </div>
  </section>
</div>

<!-- Retrospect Modal -->
<div class="modal" id="retroModal" role="dialog" aria-modal="true" aria-labelledby="retroTitle">
  <div class="modalCard">
    <div class="h1" id="retroTitle">ì˜¤ëŠ˜ì˜ íšŒê³ </div>
    <input id="rDone" placeholder="âœ… ì˜¤ëŠ˜ ëë‚¸ ì¼ í•œ ì¤„" />
    <textarea id="rFeel" rows="3" placeholder="ğŸ’­ ëŠë‚€ ì "></textarea>
    <input id="rNext" placeholder="ğŸ” ë‚´ì¼ ì´ì–´ê°ˆ í¬ì¸íŠ¸" />
    <div class="modalBtns">
      <button id="rCancel" class="btn">ë‚˜ì¤‘ì—</button>
      <button id="rSave" class="btn">ì €ì¥</button>
    </div>
  </div>
</div>

<!-- Right-bottom toast -->
<div id="retroToast" class="toast" role="status" aria-live="polite">
  <div class="tmsg" id="toastTitle">ì™„ë£Œí–ˆìŠµë‹ˆë‹¤!</div>
  <div class="tdesc">íšŒê³ ë¡ì„ ì—¬ì‹œê² ì–´ìš”?</div>
  <div class="tbtns">
    <button id="tLater" class="btn">ë‚˜ì¤‘ì—</button>
    <button id="tOpen"  class="btn">ì—´ê¸°</button>
  </div>
</div>

<!-- Reward Toast -->
<div id="buyToast" class="toast" role="status" aria-live="polite" style="bottom:92px">
  <div class="tmsg">ë³´ìƒ êµ¬ë§¤ ì™„ë£Œ!</div>
  <div class="small">ì¦ê¸°ì„¸ìš”!</div>
</div>

<script>


/* ===== 1) ìœ í‹¸/ìƒíƒœ/ì—˜ë¦¬ë¨¼íŠ¸ ===== */
const todayKey = () => new Date().toISOString().slice(0,10);
const $ = id => document.getElementById(id);

const defaults = [
  { name:'í•¸ë“œë“œë¦½ ì»¤í”¼ 1ì”', cost:80 },
  { name:'ì˜ìƒ 30ë¶„ ê°ìƒ',   cost:60 },
  { name:'ì‚°ì±… 20ë¶„',       cost:40 },
  { name:'ê²Œì„ 30ë¶„',       cost:90 },
  { name:'ì±… êµ¬ì… 1ë§Œì›',   cost:500 },
  { name:'ë§›ìˆëŠ” ê°„ì‹',     cost:120 }
];

const state = {
  user:null,
  profileName:null,
  meta:{ xp:0, level:1, coins:0, streak:0, lastClear:null, selected:null, stats:{} },
  quests:[],
  rewards:[],
  retro:{}
};

const els = {
  today:$('today'), greet:$('greet'),
  list:$('list'), input:$('input'), add:$('add'),
  xp:$('xp'), level:$('level'), coins:$('coins'),
  xpbar:$('xpbar'), xpPct:$('xpPct'), dailybar:$('dailybar'), dailyPct:$('dailyPct'),
  log:$('log'), logbox:$('logbox'), streak:$('streak'),
  store:$('store'),
  modal:$('retroModal'), rDone:$('rDone'), rFeel:$('rFeel'), rNext:$('rNext'),
  rSave:$('rSave'), rCancel:$('rCancel'),
  rewardName:$('rewardName'), rewardCost:$('rewardCost'), rewardAdd:$('rewardAdd'),
  kebab:document.getElementById('kebab'), kebabBtn:$('kebabBtn'), kebabMenu:$('kebabMenu'),
  giveUpToday:$('giveUpToday'), resetLevel:$('resetLevel'), logout:$('logout'),
  overlay:$('seasonOverlay'),
  retroToast:$('retroToast'), toastTitle:$('toastTitle'), tOpen:$('tOpen'), tLater:$('tLater'),
  buyToast:$('buyToast')
};

function blip(freq=880,ms=120){
  try{
    const ac=new (window.AudioContext||window.webkitAudioContext)();
    const o=ac.createOscillator(), g=ac.createGain();
    o.type='square'; o.frequency.value=freq; o.connect(g); g.connect(ac.destination);
    o.start(); g.gain.exponentialRampToValueAtTime(0.0001, ac.currentTime+ms/1000); setTimeout(()=>ac.close(),ms+80);
  }catch{}
}
function log(msg){
  const now=new Date();
  const line=`[${now.toTimeString().slice(0,5)}] ${msg}`;
  const prev=els.log.textContent==='ì•„ì§ ê¸°ë¡ ì—†ìŒ' ? '' : els.log.textContent+' ';
  els.log.textContent=prev+line;
  els.logbox.classList.add('flash'); setTimeout(()=>els.logbox.classList.remove('flash'),600);
}

/* ===== 2) ì¸ì¦ â†’ ë¡œë“œ ===== */
async function ensureAuthAndLoad(){
  const { data:{ user } } = await sb.auth.getUser();
  if(!user){ location.href='login.html'; return; }
  state.user=user;

  // ë‹‰ë„¤ì„: profiles.display_name â†’ user_metadata.display_name â†’ email prefix
  const { data:prof } = await sb.from('profiles').select('display_name').eq('id', user.id).maybeSingle();
  const nickname = prof?.display_name || user.user_metadata?.display_name || (user.email? user.email.split('@')[0] : 'ì‚¬ìš©ì');
  state.profileName = nickname;
  els.greet.textContent = `${nickname}ë‹˜ ì•ˆë…•í•˜ì„¸ìš” ì˜¤ëŠ˜ë„ ì¦ê±°ìš´ ë ˆë²¨ì—… ë˜ì„¸ìš” :)`;

  // ë©”íƒ€
  let { data:meta } = await sb.from('meta').select('*').eq('user_id', user.id).maybeSingle();
  if(!meta){
    await sb.from('meta').insert({ user_id:user.id, xp:0, level:1, coins:0, streak:0, last_clear:null });
    meta = { xp:0, level:1, coins:0, streak:0, last_clear:null };
  }
  state.meta.xp = meta.xp||0;
  state.meta.level = meta.level||1;
  state.meta.coins = meta.coins||0;
  state.meta.streak = meta.streak||0;
  state.meta.lastClear = meta.last_clear;
  state.meta.stats[todayKey()] ||= { total:0, done:0 };

  await Promise.all([loadTodayQuests(), loadRewards()]);
  render();
}
async function saveMeta(){
  await sb.from('meta').upsert({
    user_id:state.user.id,
    xp:state.meta.xp, level:state.meta.level,
    coins:state.meta.coins, streak:state.meta.streak,
    last_clear:state.meta.lastClear
  });
}

/* ===== 3) DB CRUD ===== */
async function loadTodayQuests(){
  const { data, error } = await sb.from('quests')
    .select('*').eq('user_id', state.user.id).eq('date', todayKey())
    .order('created_at', { ascending:false });
  if(error){ console.error(error); return; }
  state.quests = data||[];
  state.meta.stats[todayKey()] = {
    total: state.quests.length,
    done: state.quests.filter(q=>q.done).length
  };
}
async function addQuestDB(text){
  const { data, error } = await sb.from('quests')
    .insert({ user_id:state.user.id, text, date:todayKey(), doing:false, done:false, rewarded:false })
    .select().single();
  if(error){ console.error(error); return null; }
  return data;
}
async function updateQuestDB(id, patch){
  const { error } = await sb.from('quests').update(patch).eq('id', id);
  if(error) console.error(error);
}
async function deleteQuestDB(id){
  const { error } = await sb.from('quests').delete().eq('id', id);
  if(error) console.error(error);
}

async function loadRewards(){
  const { data, error } = await sb.from('rewards').select('*').eq('user_id', state.user.id).order('created_at',{ascending:false});
  if(error){ console.error(error); return; }
  state.rewards = data||[];
  if(!state.rewards.length){
    const rows = defaults.map(d=>({ user_id:state.user.id, name:d.name, cost:d.cost }));
    await sb.from('rewards').insert(rows);
    const { data:newRows } = await sb.from('rewards').select('*').eq('user_id', state.user.id).order('created_at',{ascending:false});
    state.rewards = newRows||[];
  }
}
async function addRewardDB(name, cost){
  const { data, error } = await sb.from('rewards').insert({ user_id:state.user.id, name, cost:Math.floor(cost) }).select().single();
  if(error){ console.error(error); return null; }
  return data;
}
async function updateRewardDB(id, patch){
  const { error } = await sb.from('rewards').update(patch).eq('id', id);
  if(error) console.error(error);
}
async function deleteRewardDB(id){
  const { error } = await sb.from('rewards').delete().eq('id', id);
  if(error) console.error(error);
}
async function insertRetro(done, feel, next){
  const { error } = await sb.from('retros').insert({ user_id:state.user.id, done, feel, next });
  if(error) console.error(error);
}

/* ===== 4) ë¹„ì¦ˆ ë¡œì§ ===== */
function gainXP(n=10){
  const before = state.meta.xp % 100;
  state.meta.xp += n; state.meta.coins += n;
  if((state.meta.xp % 100) < before){ state.meta.level += 1; log(`Level Up! â†’ ${state.meta.level}`); blip(1200,150); }
  else blip(980,110);
  saveMeta();
}
function showRetroToast(message){
  els.toastTitle.textContent = message || 'ì™„ë£Œí–ˆìŠµë‹ˆë‹¤!';
  els.retroToast.classList.add('show');
}
function hideRetroToast(){ els.retroToast.classList.remove('show'); }

/* í€˜ìŠ¤íŠ¸ */
async function addQuest(text){
  const t=text.trim(); if(!t) return;
  const row = await addQuestDB(t); if(!row) return;
  state.quests.unshift(row);
  state.meta.stats[todayKey()].total++;
  state.meta.selected = row.id;
  log(`Added: ${t}`); render();
}
async function toggleDone(q){
  if(q.done){
    q.done=false; await updateQuestDB(q.id,{done:false,doing:false}); log(`Reopened: ${q.text}`);
  }else{
    q.done=true; q.doing=false;
    const patch={done:true,doing:false};
    if(!q.rewarded){ q.rewarded=true; patch.rewarded=true; gainXP(10); }
    await updateQuestDB(q.id, patch);
    log(`Completed: ${q.text} (+10 XP once)`); showRetroToast(`â€˜${q.text}â€™ ì™„ë£Œ!`);
  }
  const today=todayKey();
  const items=state.quests.filter(x=>x.date===today);
  state.meta.stats[today].done = items.filter(x=>x.done).length;
  const allDone = items.length>0 && items.every(x=>x.done);
  if(allDone && state.meta.lastClear!==today){
    state.meta.streak+=1; state.meta.lastClear=today; log(`All quests cleared! Streak +1 â†’ ${state.meta.streak}`); saveMeta();
  }
  render();
}

/* ë¦¬ì›Œë“œ */
async function addReward(name, cost){
  const n=name.trim(), c=Number(cost);
  if(!n || !Number.isFinite(c) || c<=0){ blip(250,160); return; }
  const row=await addRewardDB(n,c); if(!row) return;
  state.rewards.unshift(row); log(`Reward ì¶”ê°€: ${row.name} (${row.cost} ì½”ì¸)`); renderStore();
}
function showBuyToast(){ els.buyToast.classList.add('show'); setTimeout(()=>els.buyToast.classList.remove('show'),1600); }
async function buyReward(r){
  if(state.meta.coins < r.cost){ log(`ì½”ì¸ì´ ë¶€ì¡±í•©ë‹ˆë‹¤ (${r.name})`); blip(220,160); return; }
  state.meta.coins -= r.cost; await saveMeta();
  log(`Reward ì‚¬ìš©: ${r.name} (-${r.cost} ì½”ì¸)`); blip(700,150);
  showBuyToast(); renderStats(); renderStore();
}
async function editReward(r){
  const n=prompt('ë¦¬ì›Œë“œ ì´ë¦„', r.name); if(n===null) return;
  const c=prompt('í•„ìš” ì½”ì¸', r.cost); if(c===null) return;
  const cost=Number(c); if(!n.trim()||!Number.isFinite(cost)||cost<=0){ blip(250,160); return; }
  await updateRewardDB(r.id,{name:n.trim(), cost:Math.floor(cost)});
  r.name=n.trim(); r.cost=Math.floor(cost); log(`Reward ìˆ˜ì •: ${r.name} (${r.cost} ì½”ì¸)`); renderStore();
}
async function deleteReward(id){
  await deleteRewardDB(id);
  state.rewards = state.rewards.filter(x=>x.id!==id);
  log('Reward ì‚­ì œ ì™„ë£Œ'); renderStore();
}

/* íšŒê³  ëª¨ë‹¬ */
function openRetro(){
  els.modal.classList.add('show');
  els.rDone.value=''; els.rFeel.value=''; els.rNext.value='';
  setTimeout(()=>els.rDone.focus(),10);
}
function closeRetro(){ els.modal.classList.remove('show'); }

/* ì¼€ë°¥ ë©”ë‰´ */
function toggleKebab(show){
  const willShow = typeof show==='boolean' ? show : !els.kebabMenu.classList.contains('show');
  els.kebabMenu.classList.toggle('show', willShow);
  els.kebabBtn.setAttribute('aria-expanded', willShow ? 'true' : 'false');
}
async function doLogout(){
  try{ await sb.auth.signOut(); }catch(e){}
  location.href='login.html';
}

/* ë¦¬ì…‹ */
async function resetToday(){
  if(!confirm('ì˜¤ëŠ˜ í€˜ìŠ¤íŠ¸ë¥¼ ì •ë§ í¬ê¸°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

  const t = todayKey();
  const start = t+'T00:00:00.000Z';
  const next = new Date(start); next.setUTCDate(next.getUTCDate()+1);
  const end = next.toISOString();

  await Promise.all([
    sb.from('quests').delete().eq('user_id', state.user.id).eq('date', t),
    sb.from('retros').delete().eq('user_id', state.user.id).gte('created_at', start).lt('created_at', end),
  ]);

  state.quests = state.quests.filter(q=>q.date!==t);
  delete state.retro[t];
  state.meta.stats[t] = { total:0, done:0 };
  state.meta.selected = null;

  render(); log('ì˜¤ëŠ˜ ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
  celebrateReset(false);
  toggleKebab(false);
}
async function resetLevel(){
  if(!confirm('ì •ë§ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë ˆë²¨/XP/ì½”ì¸/ìŠ¤íŠ¸ë¦­ì´ 0ì´ ë©ë‹ˆë‹¤)')) return;

  state.meta.xp=0; state.meta.level=1; state.meta.coins=0; state.meta.streak=0; state.meta.lastClear=null;
  await saveMeta();
  render(); log('ë ˆë²¨ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.'); blip(500,200);
  toggleKebab(false);
}

/* ì´ˆê¸°í™” ì¶•í•˜ ì—°ì¶œ */
function celebrateReset(full=true){
  try{
    els.overlay.classList.remove('show'); void els.overlay.offsetWidth;
    els.overlay.querySelector('.msg').textContent = full ? 'ìƒˆ ì‹œì¦Œì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!' : 'ìƒˆë¡œìš´ í•˜ë£¨ê°€ ì‹œì‘ë˜ì—ˆë„¤ìš”! ì˜¤ëŠ˜ì˜ í€˜ìŠ¤íŠ¸ë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”!';
    els.overlay.classList.add('show');
    for(let i=0;i<22;i++){
      const p=document.createElement('div'); p.className='particle';
      const x=Math.random()*95+2; const delay=Math.random()*0.6;
      p.style.left = x+'vw'; p.style.top='-10px'; p.style.animationDelay=delay+'s';
      document.body.appendChild(p); setTimeout(()=>p.remove(), 2000);
    }
  }catch(e){}
}

/* ===== 5) ë Œë”ë§ ===== */
function render(){
  els.today.textContent = new Date().toLocaleDateString('ko-KR',{year:'numeric',month:'2-digit',day:'2-digit',weekday:'short'});
  renderQuests(); renderStats(); renderStore();
}
function renderQuests(){
  els.list.innerHTML='';
  const today=todayKey();
  const items=state.quests.filter(q=>q.date===today);
  state.meta.stats[today] ||= { total:0, done:0 };
  state.meta.stats[today].total = items.length;
  state.meta.stats[today].done  = items.filter(q=>q.done).length;

  items.forEach(q=>{
    const row=document.createElement('div');
    row.className='card'+(q.done?' done':'')+(state.meta.selected===q.id?' flash':'');
    row.tabIndex=0;

    const badge=document.createElement('div'); badge.className='badge'; badge.textContent=q.done?'DONE':(q.doing?'DOING':'TODO');
    const title=document.createElement('div'); title.className='title'; title.textContent=q.text;

    const actions=document.createElement('div'); actions.className='row';
    const bDo=mkBtn('ì§„í–‰','Doing',async()=>{ q.doing=true; q.done=false; await updateQuestDB(q.id,{doing:true,done:false}); log(`Started: ${q.text}`); render(); });
    const bDone=mkBtn('ì™„ë£Œ','Complete',()=>toggleDone(q));
    const bDel=mkBtn('ì‚­ì œ','Delete',async()=>{ await deleteQuestDB(q.id); state.quests = state.quests.filter(x=>x.id!==q.id); log(`Deleted: ${q.text}`); render(); });
    actions.append(bDo,bDone,bDel);

    row.onclick = ()=> state.meta.selected=q.id;
    row.append(badge,title,actions);
    els.list.append(row);
  });

  if(!items.length) els.list.innerHTML = `<div class="small">ì˜¤ëŠ˜ í€˜ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. ìœ„ ì…ë ¥ì°½ì—ì„œ ì¶”ê°€í•˜ì„¸ìš”.</div>`;
}
function renderStats(){
  const xp100=state.meta.xp%100;
  els.xp.textContent=xp100; els.level.textContent=state.meta.level; els.coins.textContent=state.meta.coins;
  const xpPct=Math.min(100, Math.floor(xp100)); els.xpbar.style.width=xpPct+'%'; els.xpPct.textContent=xpPct+'%';

  const today=todayKey();
  const items=state.quests.filter(q=>q.date===today);
  const dailyPct = items.length ? Math.floor(items.filter(q=>q.done).length/items.length*100) : 0;
  els.dailybar.style.width=dailyPct+'%'; els.dailyPct.textContent=dailyPct+'%';
  els.streak.textContent=`Streak ${state.meta.streak} day`;
}
function renderStore(){
  els.store.innerHTML='';
  state.rewards.forEach(item=>{
    const wrap=document.createElement('div'); wrap.className='storeItem';
    wrap.innerHTML=`<div class="name">${item.name}</div><div class="cost">${item.cost} ì½”ì¸</div>`;
    const buy=document.createElement('button'); buy.className='buy'; buy.textContent='BUY'; buy.onclick=()=>buyReward(item);

    const row=document.createElement('div'); row.className='miniRow';
    const edit=document.createElement('button'); edit.className='mini'; edit.textContent='ìˆ˜ì •'; edit.onclick=()=>editReward(item);
    const del=document.createElement('button'); del.className='mini'; del.textContent='ì‚­ì œ'; del.onclick=()=>deleteReward(item.id);
    row.append(edit,del);

    wrap.append(buy,row);
    els.store.append(wrap);
  });
}
function mkBtn(txt,title,on){ const d=document.createElement('div'); d.className='iconbtn'; d.textContent=txt; d.title=title; d.onclick=on; return d; }

/* ===== 6) ì´ë²¤íŠ¸ ë°”ì¸ë”© ===== */
els.add.onclick = async ()=>{ await addQuest(els.input.value); els.input.value=''; els.input.focus(); };
els.input.addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); els.add.click(); } });

els.rewardAdd.onclick = async ()=>{ await addReward(els.rewardName.value, els.rewardCost.value); els.rewardName.value=''; els.rewardCost.value=''; els.rewardName.focus(); };

els.kebabBtn.addEventListener('click',e=>{ e.stopPropagation(); toggleKebab(); });
document.addEventListener('click',e=>{ if(!els.kebab.contains(e.target)) toggleKebab(false); });

els.giveUpToday.onclick = resetToday;
els.resetLevel.onclick  = resetLevel;
els.logout.onclick      = doLogout;

document.addEventListener('keydown',e=>{ if(e.key==='Escape' && els.modal.classList.contains('show')) closeRetro(); });
els.rCancel.onclick = ()=> closeRetro();
els.rSave.onclick = async ()=>{
  const date=todayKey();
  const obj={ done:els.rDone.value.trim(), feel:els.rFeel.value.trim(), next:els.rNext.value.trim(), ts:Date.now() };
  state.retro[date]=obj; await insertRetro(obj.done, obj.feel, obj.next);
  log(`Retrospect saved for ${date}`); closeRetro();
};
els.tOpen.onclick = ()=>{ hideRetroToast(); openRetro(); };
els.tLater.onclick = ()=> hideRetroToast();

/* ===== 7) ì‹œì‘ ===== */
els.today.textContent = new Date().toLocaleDateString('ko-KR',{year:'numeric',month:'2-digit',day:'2-digit',weekday:'short'});
ensureAuthAndLoad();
</script>



</body>
</html>
